<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MENTOR Academy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #818cf8;
            --bg: #f1f5f9; --surface: #ffffff; --text-main: #1e293b; --text-sub: #64748b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --shadow: 0 10px 30px -10px rgba(99, 102, 241, 0.2);
            --glass: rgba(255, 255, 255, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); overflow: hidden; height: 100vh; width: 100vw; }

        /* --- NOTIFICATION --- */
        .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; max-width: 400px; }
        .toast { background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; margin-bottom: 10px; opacity: 0; transform: translateY(-20px); transition: 0.4s; border-left: 5px solid var(--primary); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { border-color: var(--success); } .toast.error { border-color: var(--danger); } .toast.loading { border-color: var(--primary); }

        /* --- COMMON UI --- */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; font-weight: 600; cursor: pointer; box-shadow: var(--shadow); transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .input-group { margin-bottom: 15px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; background: var(--surface); outline: none; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); }

        /* --- SCREENS --- */
        #loading-screen { position: fixed; inset: 0; background: var(--surface); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .bird { font-size: 2.5rem; color: var(--primary); position: absolute; opacity: 0; }
        .bird.fly { animation: flyIn 2.5s forwards ease-in-out; }
        @keyframes flyIn { 0% { opacity:0; transform:translate(-100px,-50px) scale(0.5); } 50% { opacity:1; transform:translate(0px,-20px) scale(1); } 100% { opacity:1; transform:translate(0px,-10px) scale(1); } }
        
        #main-app { display: none; height: 100%; width: 100%; flex-direction: column; background: var(--bg); }
        .page { flex: 1; overflow-y: auto; padding: 20px; display: none; padding-bottom: 100px; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HOME PAGE COMPONENTS --- */
        .slider-wrapper { position: relative; width: 100%; border-radius: 16px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); background: #e2e8f0; aspect-ratio: 16 / 7; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.8s; }
        .slide.active { opacity: 1; z-index: 2; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }

        /* THREE MAIN OPTIONS */
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .action-card { background: white; padding: 15px 5px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: 0.2s; border: 1px solid #f1f5f9; }
        .action-card:active { transform: scale(0.95); background: #f8fafc; }
        .action-icon { width: 45px; height: 45px; border-radius: 12px; margin: 0 auto 8px; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.2rem; }

        /* --- ROUTINE PAGE --- */
        .tab-header { display: flex; background: white; padding: 5px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-item { flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: var(--text-sub); }
        .tab-item.active { background: var(--primary); color: white; }
        .routine-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--primary); position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .routine-time { font-weight: bold; color: var(--primary); font-size: 0.9rem; }

        /* --- STUDY PAGE --- */
        .goal-header { background: linear-gradient(135deg, #8b5cf6, #6366f1); padding: 20px; border-radius: 20px; color: white; text-align: center; margin-bottom: 20px; position: relative; overflow: hidden; }
        .countdown { font-size: 2rem; font-weight: 700; margin: 10px 0; font-family: monospace; }
        .progress-container { background: rgba(255,255,255,0.2); height: 8px; border-radius: 10px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #a7f3d0; width: 0%; transition: 1s; }
        
        .study-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .task-list li { margin-bottom: 8px; list-style: none; display: flex; gap: 10px; color: var(--text-sub); font-size: 0.9rem; }
        .task-list li i { color: var(--success); margin-top: 4px; }

        /* --- BOTTOM NAV --- */
        .bottom-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; height: 70px; background: var(--glass); backdrop-filter: blur(15px); border-radius: 20px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5); z-index: 100; }
        .nav-item { color: #94a3b8; font-size: 1.3rem; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .nav-center-btn { width: 55px; height: 55px; background: var(--primary); border-radius: 18px; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.4rem; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4); margin-top: -30px; border: 5px solid var(--bg); }

        /* --- MODALS --- */
        .full-screen-modal { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: none; flex-direction: column; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { padding: 20px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 10; }

        /* Admin Styles */
        .admin-section { padding: 20px; display: none; }
        .admin-section.active { display: block; }
        .admin-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

    </style>
</head>
<body>

    <div class="toast-container" id="toastContainer"></div>

    <div id="loading-screen">
        <div style="position:relative; width: 300px; height: 100px; text-align: center;">
            <i class="fas fa-dove bird" id="birdIcon"></i>
            <h1 class="app-name" id="appName"></h1>
        </div>
    </div>

    <div id="auth-screen" style="display:none; height:100%; overflow-y:auto; background:white;">
        <div style="padding:30px; min-height:100vh; display:flex; flex-direction:column; justify-content:center;">
            <h1 style="color:var(--primary); font-size:2.5rem; text-align:center; margin-bottom:40px;">MENTOR</h1>
            <div id="loginForm">
                <div class="input-group"><input type="email" id="loginEmail" placeholder="Email"></div>
                <div class="input-group"><input type="password" id="loginPass" placeholder="Password"></div>
                <button class="btn" onclick="handleLogin()">Log In</button>
                <p style="text-align:center; margin-top:20px;">New? <b style="color:var(--primary);" onclick="toggleAuth('reg')">Register</b></p>
            </div>
            <div id="regForm" style="display:none;">
                <div class="input-group"><input type="text" id="regName" placeholder="Name"></div>
                <div class="input-group"><input type="email" id="regEmail" placeholder="Email"></div>
                <div class="input-group"><input type="password" id="regPass" placeholder="Password"></div>
                <button class="btn" onclick="handleRegister()">Sign Up</button>
                <p style="text-align:center; margin-top:20px;">Have account? <b style="color:var(--primary);" onclick="toggleAuth('login')">Log In</b></p>
            </div>
        </div>
    </div>

    <div id="main-app">
        <div id="home-page" class="page active">
            <div class="slider-wrapper" id="homeSlider">
                <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#94a3b8;"><i class="fas fa-spinner fa-spin"></i></div>
            </div>

            <h2 id="homeWelcomeName" style="margin-bottom:15px; font-size:1.5rem;">Hello!</h2>

            <div class="quick-actions">
                <div class="action-card" onclick="navTo('routine')">
                    <div class="action-card-bg"></div>
                    <div class="action-icon" style="background:#f59e0b;"><i class="fas fa-calendar-alt"></i></div>
                    <h4>Routine</h4>
                </div>
                <div class="action-card" onclick="navTo('study')">
                    <div class="action-icon" style="background:#6366f1;"><i class="fas fa-book-reader"></i></div>
                    <h4>Study</h4>
                </div>
                <div class="action-card" onclick="navTo('rank')">
                    <div class="action-icon" style="background:#ef4444;"><i class="fas fa-trophy"></i></div>
                    <h4>Rank</h4>
                </div>
            </div>
        </div>

        <div id="routine-page" class="page">
            <h2 style="margin-bottom:15px;">Daily Routine</h2>
            <div class="tab-header">
                <div class="tab-item active" onclick="switchRoutineTab('admin')" id="tab-admin">Official</div>
                <div class="tab-item" onclick="switchRoutineTab('my')" id="tab-my">My Routine</div>
            </div>

            <div id="adminRoutineList" style="display:block;">
                <p style="text-align:center; color:gray;">Loading official routines...</p>
            </div>

            <div id="myRoutineList" style="display:none;">
                <div class="input-group" style="display:flex; gap:10px;">
                    <input type="time" id="userRoutineTime" style="flex:1;">
                    <input type="text" id="userRoutineTask" placeholder="Task..." style="flex:2;">
                    <button class="btn" style="width:auto; padding:0 15px;" onclick="addUserRoutine()"><i class="fas fa-plus"></i></button>
                </div>
                <div id="userRoutineItems"></div>
            </div>
        </div>

        <div id="study-page" class="page">
            <div id="studyGoalContainer">
                <div class="goal-header">
                    <h3 id="goalTitle">No Goal Set</h3>
                    <div class="countdown" id="goalTimer">00d 00h 00m</div>
                    <p style="font-size:0.9rem; opacity:0.9;">Target Date: <span id="goalDate">--/--/--</span></p>
                    <div class="progress-container"><div class="progress-fill" id="studyProgress" style="width:0%"></div></div>
                    <p style="font-size:0.8rem; margin-top:5px; text-align:right;"><span id="progressText">0</span>% Completed</p>
                </div>

                <div class="input-group">
                    <select id="levelSelect" onchange="loadStudyCard()">
                        <option value="">Select Level / Day</option>
                        </select>
                </div>

                <div id="studyContentArea" style="display:none;">
                    <div class="study-card">
                        <h4 style="margin-bottom:15px; color:var(--primary);"><i class="fas fa-list-ul"></i> Today's Tasks</h4>
                        <div id="studyDescription" style="color:var(--text-sub); margin-bottom:20px; line-height:1.6;"></div>
                        <button class="btn" onclick="startPractice()">Practice & Unlock Next</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="rank-page" class="page"><h2>Leaderboard</h2><p>Coming Soon...</p></div>
        <div id="profile-page" class="page">
            <div style="text-align:center; margin-top:30px;">
                <div style="width:80px; height:80px; background:#e2e8f0; border-radius:50%; margin:0 auto 15px; display:flex; justify-content:center; align-items:center; font-size:2rem;"><i class="fas fa-user"></i></div>
                <h2 id="profileName">User</h2>
                <button class="btn" style="margin-top:20px; background:var(--text-main);" onclick="openAdminPanel()" id="adminBtn" style="display:none;">Admin Panel</button>
                <button class="btn" style="margin-top:10px; background:var(--danger);" onclick="auth.signOut().then(()=>location.reload())">Logout</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-home"></i></div>
            <div class="nav-item" onclick="navTo('routine')"><i class="fas fa-calendar"></i></div>
            <div class="nav-center-btn" onclick="navTo('study')"><i class="fas fa-book-open"></i></div>
            <div class="nav-item" onclick="navTo('rank')"><i class="fas fa-trophy"></i></div>
            <div class="nav-item" onclick="navTo('profile')"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <div id="practice-modal" class="full-screen-modal">
        <div class="modal-header"><h3>Practice</h3><button onclick="document.getElementById('practice-modal').style.display='none'" style="border:none; bg:none; font-size:1.5rem;">&times;</button></div>
        <div id="practiceContainer" style="padding:20px;"></div>
        <div style="padding:20px;"><button class="btn" onclick="submitPractice()">Submit</button></div>
    </div>

    <div id="admin-panel" class="full-screen-modal">
        <div class="modal-header"><h3>Admin Dashboard</h3><button onclick="document.getElementById('admin-panel').style.display='none'" style="border:none; bg:none; font-size:1.5rem;">&times;</button></div>
        <div style="padding:20px; background:#f8fafc; display:flex; gap:10px; overflow-x:auto;">
            <button class="btn" style="width:auto; padding:8px 15px;" onclick="showAdminTab('routine')">Routine</button>
            <button class="btn" style="width:auto; padding:8px 15px; background:#94a3b8;" onclick="showAdminTab('study')">Study</button>
        </div>
        
        <div id="adm-routine" class="admin-section active">
            <h4>Manage Official Routine</h4>
            <div class="input-group" style="margin-top:10px;">
                <input type="time" id="admRoutineTime">
                <input type="text" id="admRoutineTask" placeholder="Task Description" style="margin-top:5px;">
                <button class="btn" style="margin-top:5px;" onclick="addAdminRoutine()">Add Routine</button>
            </div>
            <div id="admRoutineListUI"></div>
        </div>

        <div id="adm-study" class="admin-section">
            <h4>Manage Study Goal</h4>
            <div class="input-group">
                <input type="text" id="goalNameInput" placeholder="Goal Name (e.g. HSC 2024)">
                <input type="date" id="goalDateInput" style="margin-top:5px;">
                <button class="btn" style="margin-top:5px;" onclick="setGlobalGoal()">Set Goal & Timer</button>
            </div>
            <hr style="margin:20px 0;">
            <h4>Add Study Level</h4>
            <div class="input-group">
                <input type="text" id="levelNameInput" placeholder="Level Name (e.g. Day 1)">
                <textarea id="levelDescInput" placeholder="Study Details / Syllabus" rows="3"></textarea>
                <textarea id="levelJsonInput" placeholder="MCQ JSON Data" rows="3"></textarea>
                <button class="btn" onclick="addStudyLevel()">Add Level</button>
            </div>
            <div id="admLevelList"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCRWpnJC1Z3WCNUAyfjhw8KlKyJ03z3G2w", authDomain: "mentor-ac742.firebaseapp.com", projectId: "mentor-ac742", storageBucket: "mentor-ac742.firebasestorage.app", messagingSenderId: "271805714479", appId: "1:271805714479:web:efc071e2021db4286db6da", measurementId: "G-612FVVNZVK" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const ADMIN_EMAIL = "mdwld2005@gmail.com";

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            const name = "MENTOR"; const con = document.getElementById('appName');
            name.split('').forEach((l, i) => { const s = document.createElement('span'); s.textContent = l; s.style.animationDelay = `${0.5 + (i*0.1)}s`; con.appendChild(s); });
            setTimeout(() => document.getElementById('birdIcon').classList.add('fly'), 100);
            setTimeout(() => document.querySelectorAll('.app-name span').forEach(s => s.classList.add('show')), 100);

            auth.onAuthStateChanged(user => {
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    if (user) {
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'flex';
                        initUserData(user);
                        initHomeSlider();
                    } else {
                        document.getElementById('auth-screen').style.display = 'block';
                    }
                }, 2500);
            });
        });

        function showToast(type, msg) {
            const t = document.createElement('div'); t.className = `toast ${type}`;
            t.innerHTML = `<div><h4>${type.toUpperCase()}</h4><p>${msg}</p></div>`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.classList.add('show'), 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(),400); }, 3000);
        }

        // --- NAVIGATION ---
        function navTo(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id + '-page').classList.add('active');
            
            // Highlight Icons
            const icons = document.querySelectorAll('.nav-item');
            if(id==='home') icons[0].classList.add('active');
            if(id==='routine') icons[1].classList.add('active');
            if(id==='study') document.querySelector('.nav-center-btn').style.transform = 'scale(1.1)';
            else document.querySelector('.nav-center-btn').style.transform = 'scale(1)';
            if(id==='rank') icons[3].classList.add('active');
            if(id==='profile') icons[4].classList.add('active');

            if(id==='routine') loadRoutines();
            if(id==='study') loadStudyData();
        }

        // --- AUTH & DATA ---
        function handleLogin() {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => showToast('error', err.message));
        }
        function handleRegister() {
            const n = document.getElementById('regName').value, e = document.getElementById('regEmail').value, p = document.getElementById('regPass').value;
            auth.createUserWithEmailAndPassword(e, p).then(c => {
                db.collection('students').doc(c.user.uid).set({ name: n, email: e });
            }).catch(err => showToast('error', err.message));
        }
        function toggleAuth(t) {
            document.getElementById('loginForm').style.display = t==='login'?'block':'none';
            document.getElementById('regForm').style.display = t==='reg'?'block':'none';
        }
        function initUserData(user) {
            if(user.email === ADMIN_EMAIL) document.getElementById('adminBtn').style.display = 'inline-block';
            db.collection('students').doc(user.uid).get().then(d => {
                const n = d.exists ? d.data().name : user.email.split('@')[0];
                document.getElementById('homeWelcomeName').innerText = `Hello, ${n}!`;
                document.getElementById('profileName').innerText = n;
            });
        }
        function initHomeSlider() {
            db.collection('sliders').orderBy('createdAt','desc').limit(5).get().then(snap => {
                const wrapper = document.getElementById('homeSlider');
                if(!snap.empty) {
                    let html = '';
                    snap.forEach((d, i) => html += `<div class="slide ${i===0?'active':''}"><img src="${d.data().imageUrl}"></div>`);
                    wrapper.innerHTML = html;
                    let idx = 0; const slides = document.querySelectorAll('.slide');
                    setInterval(() => {
                        slides[idx].classList.remove('active');
                        idx = (idx+1)%slides.length;
                        slides[idx].classList.add('active');
                    }, 4000);
                } else wrapper.innerHTML = '<p style="text-align:center; padding-top:20%;">No Sliders</p>';
            });
        }

        // --- ROUTINE LOGIC ---
        function switchRoutineTab(t) {
            document.getElementById('tab-admin').className = `tab-item ${t==='admin'?'active':''}`;
            document.getElementById('tab-my').className = `tab-item ${t==='my'?'active':''}`;
            document.getElementById('adminRoutineList').style.display = t==='admin'?'block':'none';
            document.getElementById('myRoutineList').style.display = t==='my'?'block':'none';
        }
        function loadRoutines() {
            // Admin Routine
            db.collection('routines').orderBy('time').onSnapshot(snap => {
                let h = '';
                snap.forEach(d => {
                    const r = d.data();
                    h += `<div class="routine-item"><div class="routine-time">${r.time}</div><div>${r.task}</div></div>`;
                });
                document.getElementById('adminRoutineList').innerHTML = h || '<p style="text-align:center; color:#94a3b8;">No official routine.</p>';
            });
            // User Routine
            const uid = auth.currentUser.uid;
            db.collection('students').doc(uid).collection('my_routine').orderBy('time').onSnapshot(snap => {
                let h = '';
                snap.forEach(d => {
                    const r = d.data();
                    h += `<div class="routine-item" style="border-color:var(--secondary);">
                        <div style="display:flex; justify-content:space-between;">
                            <span class="routine-time">${r.time}</span>
                            <i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="delUserRoutine('${d.id}')"></i>
                        </div>
                        <div>${r.task}</div>
                    </div>`;
                });
                document.getElementById('userRoutineItems').innerHTML = h || '<p style="text-align:center; color:#94a3b8;">Add your routine above.</p>';
            });
        }
        function addUserRoutine() {
            const t = document.getElementById('userRoutineTime').value;
            const task = document.getElementById('userRoutineTask').value;
            if(!t || !task) return showToast('error', 'Fill all fields');
            db.collection('students').doc(auth.currentUser.uid).collection('my_routine').add({
                time: t, task: task, createdAt: new Date()
            }).then(() => {
                document.getElementById('userRoutineTask').value = '';
                showToast('success', 'Added');
            });
        }
        function delUserRoutine(id) {
            db.collection('students').doc(auth.currentUser.uid).collection('my_routine').doc(id).delete();
        }

        // --- STUDY LOGIC (Smart) ---
        let currentLevelData = null;
        let studyTimerInt = null;

        function loadStudyData() {
            // Load Global Goal
            db.collection('app_settings').doc('study_goal').onSnapshot(doc => {
                if(doc.exists) {
                    const g = doc.data();
                    document.getElementById('goalTitle').innerText = g.title;
                    document.getElementById('goalDate').innerText = g.date;
                    startTimer(new Date(g.date));
                }
            });
            // Load Levels
            const sel = document.getElementById('levelSelect');
            db.collection('study_levels').orderBy('createdAt').get().then(snap => {
                sel.innerHTML = '<option value="">Select Level</option>';
                snap.forEach(d => {
                    sel.innerHTML += `<option value="${d.id}">${d.data().title}</option>`;
                });
            });
        }
        function startTimer(target) {
            if(studyTimerInt) clearInterval(studyTimerInt);
            studyTimerInt = setInterval(() => {
                const now = new Date().getTime();
                const dist = target - now;
                if(dist < 0) { document.getElementById('goalTimer').innerText = "EXPIRED"; return; }
                const d = Math.floor(dist / (1000*60*60*24));
                const h = Math.floor((dist % (1000*60*60*24)) / (1000*60*60));
                const m = Math.floor((dist % (1000*60*60)) / (1000*60));
                document.getElementById('goalTimer').innerText = `${d}d ${h}h ${m}m`;
            }, 60000); // update every minute
        }
        function loadStudyCard() {
            const id = document.getElementById('levelSelect').value;
            if(!id) { document.getElementById('studyContentArea').style.display = 'none'; return; }
            
            db.collection('study_levels').doc(id).get().then(doc => {
                currentLevelData = doc.data();
                document.getElementById('studyContentArea').style.display = 'block';
                document.getElementById('studyDescription').innerHTML = currentLevelData.desc.replace(/\n/g, '<br>');
            });
        }
        function startPractice() {
            if(!currentLevelData || !currentLevelData.questions) return showToast('error', 'No practice data!');
            document.getElementById('practice-modal').style.display = 'flex';
            const con = document.getElementById('practiceContainer');
            con.innerHTML = '';
            currentLevelData.questions.forEach((q, i) => {
                let opts = '';
                q.options.forEach((o, j) => opts += `<div style="padding:10px; border:1px solid #ddd; margin:5px 0; cursor:pointer;" onclick="selectOpt(this, ${i})">${j+1}. ${o}</div>`);
                con.innerHTML += `<div class="q-block" id="q-${i}" data-ans="${q.correct}"><p><b>Q${i+1}:</b> ${q.q}</p>${opts}</div><hr>`;
            });
        }
        function selectOpt(el, i) {
            const p = el.parentNode;
            p.querySelectorAll('div').forEach(d => d.style.background = 'white');
            el.style.background = '#dcfce7';
            el.classList.add('selected-opt');
        }
        function submitPractice() {
            const blocks = document.querySelectorAll('.q-block');
            let score = 0;
            blocks.forEach(b => {
                const sel = b.querySelector('.selected-opt');
                if(sel) {
                    const ansIndex = Array.from(sel.parentNode.children).indexOf(sel) - 1; // -1 for p tag
                    if(ansIndex == b.getAttribute('data-ans')) score++;
                }
            });
            const percent = (score / blocks.length) * 100;
            if(percent >= 80) {
                showToast('success', `Awesome! You got ${percent}%`);
                document.getElementById('practice-modal').style.display = 'none';
                updateProgress(10); // Dummy increment
            } else {
                showToast('error', `You got ${percent}%. Need 80% to pass.`);
            }
        }
        function updateProgress(inc) {
            const bar = document.getElementById('studyProgress');
            const txt = document.getElementById('progressText');
            let curr = parseInt(txt.innerText);
            let newV = Math.min(curr + inc, 100);
            bar.style.width = newV + '%';
            txt.innerText = newV;
        }

        // --- ADMIN PANEL FUNCTIONS ---
        function openAdminPanel() { document.getElementById('admin-panel').style.display = 'flex'; showAdminTab('routine'); }
        function showAdminTab(t) {
            document.querySelectorAll('.admin-section').forEach(d => d.style.display = 'none');
            document.getElementById('adm-'+t).style.display = 'block';
            if(t==='routine') loadAdminRoutinesUI();
            if(t==='study') loadAdminLevelsUI();
        }
        // Admin Routine
        function addAdminRoutine() {
            const t = document.getElementById('admRoutineTime').value;
            const task = document.getElementById('admRoutineTask').value;
            if(!t || !task) return;
            db.collection('routines').add({ time:t, task:task }).then(() => {
                showToast('success', 'Routine Added');
                loadAdminRoutinesUI();
            });
        }
        function loadAdminRoutinesUI() {
            db.collection('routines').orderBy('time').get().then(snap => {
                let h = '';
                snap.forEach(d => h += `<div class="admin-card"><span>${d.data().time} - ${d.data().task}</span> <button onclick="db.collection('routines').doc('${d.id}').delete().then(()=>loadAdminRoutinesUI())" style="color:red;">Del</button></div>`);
                document.getElementById('admRoutineListUI').innerHTML = h;
            });
        }
        // Admin Study
        function setGlobalGoal() {
            const t = document.getElementById('goalNameInput').value;
            const d = document.getElementById('goalDateInput').value;
            db.collection('app_settings').doc('study_goal').set({ title:t, date:d }).then(()=>showToast('success','Goal Set'));
        }
        function addStudyLevel() {
            const t = document.getElementById('levelNameInput').value;
            const d = document.getElementById('levelDescInput').value;
            const j = document.getElementById('levelJsonInput').value;
            try {
                const q = JSON.parse(j);
                db.collection('study_levels').add({ title:t, desc:d, questions:q, createdAt: new Date() }).then(()=>{
                    showToast('success', 'Level Added');
                    loadAdminLevelsUI();
                });
            } catch(e) { showToast('error', 'Invalid JSON'); }
        }
        function loadAdminLevelsUI() {
            db.collection('study_levels').orderBy('createdAt').get().then(snap => {
                let h = '';
                snap.forEach(d => h += `<div class="admin-card"><span>${d.data().title}</span> <button onclick="db.collection('study_levels').doc('${d.id}').delete().then(()=>loadAdminLevelsUI())" style="color:red;">Del</button></div>`);
                document.getElementById('admLevelList').innerHTML = h;
            });
        }

    </script>
</body>
</html>
