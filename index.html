<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamPro - Student Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #6C63FF;
            --secondary: #8f94fb;
            --primary-dark: #5a52d5; 
            --primary-light: #6c63ff26;
            --bg: #F4F7F6;
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-sec: #636e72;
            --border: #eeeeee;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --radius: 18px;
            --danger: #ff4757;
            --success: #2ecc71;
            --white: #ffffff;
            --warning: #ffa502;
            --live-color: #ff3838;
            --medium: #f39c12;
            --gradient-primary: linear-gradient(135deg, #6C63FF 0%, #8f94fb 100%);
            --gradient-secondary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #2ecc71 0%, #1dd1a1 100%);
            --gradient-danger: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            --gradient-warning: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            --day-gradient-header: linear-gradient(135deg, #6C63FF 0%, #8f94fb 100%);
            --day-gradient-card: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --night-gradient-header: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --night-gradient-card: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
        }

        .dark-mode {
            --bg: #1e1e2e;
            --card-bg: #27293d;
            --text: #e0e0e0;
            --text-sec: #a0a0a0;
            --border: #444444;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --primary-light: #6c63ff4d;
            --live-color: #ff6b6b;
            --gradient-primary: var(--night-gradient-card);
            --gradient-secondary: var(--night-gradient-header);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; }
        body { 
            background: var(--bg); color: var(--text); padding-bottom: 90px; 
            transition: background 0.3s, color 0.3s; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: contain;
        }
        
        /* UTILS */
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.4s ease; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        /* SPLASH SCREEN STYLES */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease-out;
        }
        .splash-logo-container {
            position: relative; width: 120px; height: 120px;
        }
        .splash-logo {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: pulseLogo 2s infinite ease-in-out;
            border: 4px solid var(--primary);
        }
        .splash-text {
            margin-top: 20px; font-size: 1.5rem; font-weight: 700; color: var(--primary);
            animation: fadeInUp 1s ease forwards; opacity: 0;
        }
        @keyframes pulseLogo {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(108, 99, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 99, 255, 0); }
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* NETWORK STATUS POPUP */
        #network-status {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: var(--danger); color: white; text-align: center; 
            padding: 12px; z-index: 100000; display: none;
            font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* INPUTS */
        input, select, textarea {
            width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 15px;
            background: var(--card-bg); color: var(--text); font-size: 1rem; margin-bottom: 12px;
            outline: none; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15); }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 5px; transition: 0.2s; }
        .btn-primary { background: var(--gradient-primary); color: white; box-shadow: 0 8px 20px rgba(0,0,0, 0.2); }
        .btn-danger { background: var(--gradient-danger); color: white; }
        .btn-sec { background: var(--border); color: var(--text); }
        .btn-success { background: var(--gradient-success); color: white; }
        .btn-warning { background: var(--gradient-warning); color: white; }
        .btn:active { transform: scale(0.98); }

        /* HEADER */
        header { 
            background: var(--gradient-primary);
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            transition: background 0.3s ease;
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--white) !important; }
        #theme-icon { color: var(--white) !important; opacity: 0.9; }
        
        /* CARDS */
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        
        /* NOTIFICATION SLIDER */
        .news-slider { width: 100%; overflow: hidden; margin-bottom: 15px; display: none; }
        .news-track { display: flex; gap: 10px; animation: slideLeft 15s linear infinite; }
        .news-item {
            background: var(--card-bg); padding: 10px 15px; border-radius: 50px;
            white-space: nowrap; border: 1px solid var(--primary); color: var(--primary);
            font-size: 0.9rem; font-weight: 500; box-shadow: var(--shadow);
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .news-item.new-notification {
            animation: pulseNotification 2s infinite;
            background: var(--gradient-primary);
            color: white;
            border: none;
        }
        @keyframes slideLeft { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes pulseNotification {
            0% { box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(108, 99, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(108, 99, 255, 0); }
        }

        /* HOMEPAGE SLIDER STYLES */
        .slides-container {
            width: 100%;
            height: 0;
            padding-top: 43.75%;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            background: var(--card-bg);
        }

        .slides-track {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            transition: transform 0.5s ease;
        }

        .slide {
            min-width: 100%;
            height: 100%;
            position: relative;
        }

        .slide a {
            display: block;
            width: 100%;
            height: 100%;
        }

        .slide-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .slide-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 20px;
            color: white;
        }

        .slide-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .slide-desc {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .slide-indicators {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 10;
        }

        .slide-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: 0.3s;
        }

        .slide-indicator.active {
            background: white;
            transform: scale(1.2);
        }

        .slide-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: 0.3s;
            opacity: 0;
        }

        .slides-container:hover .slide-nav {
            opacity: 1;
        }

        .slide-nav.prev {
            left: 10px;
        }

        .slide-nav.next {
            right: 10px;
        }

        .slide-nav:hover {
            background: rgba(0,0,0,0.8);
            transform: translateY(-50%) scale(1.1);
        }

        /* NOTIFICATION POPUP */
        .notification-popup {
            position: fixed; top: 70px; right: 20px;
            background: var(--card-bg); padding: 15px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 10000;
            display: none; width: 320px; border-left: 5px solid var(--primary);
            animation: slideInRight 0.3s ease;
            border: 1px solid var(--border);
            max-height: 400px; overflow-y: auto;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }
        .notification-item {
            padding: 10px; border-radius: 10px; margin-bottom: 8px;
            background: var(--bg); border-left: 3px solid var(--primary);
            font-size: 0.85rem; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .notification-item.unread { background: var(--primary-light); font-weight: 500; }
        .notification-delete {
            background: transparent; border: none; color: var(--danger);
            cursor: pointer; font-size: 1rem; margin-left: 10px;
            width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: 0.2s;
        }
        .notification-delete:hover { background: rgba(255, 71, 87, 0.1); }
        .notification-clear-all {
            width: 100%; margin-top: 10px; padding: 10px;
            background: var(--gradient-danger); color: white; border-radius: 10px;
            border: none; cursor: pointer; font-weight: 600;
        }

        /* MCQ STYLES */
        .mcq-anim { animation: slideUp 0.5s ease forwards; opacity: 0; }
        .mcq-option {
            display: flex; align-items: center; padding: 15px; margin-top: 10px;
            border: 2px solid var(--border); border-radius: 12px; cursor: pointer;
            transition: all 0.2s; background: var(--card-bg);
        }
        .mcq-option:hover { border-color: var(--primary); background: var(--bg); transform: translateX(5px); }
        .mcq-option.selected { border-color: var(--primary); background: var(--primary-light); font-weight: 600; }
        .mcq-circle {
            height: 20px; width: 20px; border: 2px solid var(--text-sec); border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
        }
        .mcq-option.selected .mcq-circle { border-color: var(--primary); background: var(--primary); }
        .mcq-option.selected .mcq-circle::after { content: ''; width: 8px; height: 8px; background: white; border-radius: 50%; }

        /* RESULT CARD COLOR BASED ON PERCENTAGE */
        .result-card-green {
            border-left: 5px solid var(--success) !important;
            background: linear-gradient(90deg, rgba(46, 204, 113, 0.1), transparent) !important;
        }
        .result-card-red {
            border-left: 5px solid var(--danger) !important;
            background: linear-gradient(90deg, rgba(255, 71, 87, 0.1), transparent) !important;
        }
        .result-card-medium {
            border-left: 5px solid var(--medium) !important;
            background: linear-gradient(90deg, rgba(243, 156, 18, 0.1), transparent) !important;
        }

        /* CURRENT USER HIGHLIGHT IN LEADERBOARD */
        .current-user-card {
            border: 3px solid var(--primary) !important;
            background: linear-gradient(135deg, rgba(108, 99, 255, 0.15), transparent) !important;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(108, 99, 255, 0.2) !important;
            position: relative;
            overflow: hidden;
        }
        .current-user-card::before {
            content: 'YOU';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--gradient-primary);
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            z-index: 1;
        }

        /* GRID CARDS */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
        .mini-card {
            background: var(--card-bg); padding: 15px; border-radius: 15px;
            box-shadow: var(--shadow); text-align: center; cursor: pointer;
            border: 1px solid var(--border); transition: 0.2s; position: relative; overflow: hidden;
        }
        .mini-card:active { transform: scale(0.95); }
        .mini-card img { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; border: 2px solid var(--border); }
        .mini-card h4 { font-size: 0.9rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mini-card small { font-size: 0.75rem; color: var(--text-sec); }
        .banned-badge { position: absolute; top: 0; right: 0; background: var(--gradient-danger); color: white; font-size: 0.6rem; padding: 2px 8px; border-bottom-left-radius: 10px; }

        /* DASHBOARD */
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .dash-btn { background: var(--card-bg); padding: 20px 10px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border: 1px solid var(--border); }
        
        /* LEVEL BADGE */
        .level-badge {
            display: inline-block; padding: 3px 10px; border-radius: 20px;
            font-size: 0.7rem; font-weight: 600; margin-left: 5px;
            background: var(--gradient-primary);
            color: white;
        }

        /* LIVE BADGE */
        .live-badge {
            position: absolute; top: 10px; right: 10px;
            background: var(--live-color); color: white; font-size: 0.6rem;
            padding: 3px 8px; border-radius: 10px; animation: pulseLive 1.5s infinite;
            display: flex; align-items: center; gap: 3px;
        }
        @keyframes pulseLive {
            0% { box-shadow: 0 0 0 0 rgba(255, 56, 56, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(255, 56, 56, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 56, 56, 0); }
        }

        /* NAV */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--card-bg); display: flex; justify-content: space-around; 
            padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); 
            z-index: 1000; border-top: 1px solid var(--border); 
        }
        .nav-item { 
            text-align: center; color: #aaa; font-size: 0.7rem; cursor: pointer; 
            flex: 1; display: flex; flex-direction: column; align-items: center;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 3px; display: block; }

        /* MODAL & ALERT */
        #custom-alert {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg); padding: 25px; width: 90%; max-width: 350px;
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center; z-index: 10000; display: none; transition: 0.3s; border: 1px solid var(--border);
        }
        #custom-alert.show { display: block; animation: popIn 0.3s forwards; }
        @keyframes popIn { to { transform: translate(-50%, -50%) scale(1); } }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }

        /* FIXED POPUP CENTER */
        #confirm-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 110000;
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
        }

        #confirm-modal.active {
            display: flex !important;
        }

        .confirm-box {
            background: var(--card-bg); 
            width: 90%; 
            max-width: 320px; 
            padding: 25px;
            border-radius: 20px; 
            text-align: center; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .confirm-icon { font-size: 3rem; color: var(--danger); margin-bottom: 15px; }
        .confirm-btns { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }

        /* PULL TO REFRESH INDICATOR */
        #refresh-indicator {
            position: fixed; top: -50px; left: 50%; transform: translateX(-50%);
            background: var(--card-bg); padding: 10px; border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 9999;
            transition: top 0.3s;
            display: flex; justify-content: center; align-items: center;
            width: 40px; height: 40px; color: var(--primary);
        }

        /* SMALL SPINNER FOR API */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* SHARE MODAL */
        .share-options {
            display: flex; flex-direction: column; gap: 10px; margin-top: 15px;
        }
        .share-option-btn {
            display: flex; align-items: center; gap: 10px;
            padding: 15px; border-radius: 12px; background: var(--bg);
            border: 2px solid var(--border); cursor: pointer; transition: 0.2s;
        }
        .share-option-btn:hover {
            border-color: var(--primary); background: var(--primary-light);
            transform: translateX(5px);
        }
        .share-option-btn i {
            font-size: 1.5rem; width: 40px; text-align: center;
        }
        .telegram-btn { color: #0088cc; }
        .website-btn { color: var(--primary); }
        .app-btn { color: var(--success); }

        /* PROFILE CARD */
        .profile-header-card {
            background: var(--gradient-primary);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .profile-avatar-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 4px solid rgba(255,255,255,0.3);
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }
        .profile-avatar-container:hover::after {
            content: '\f030';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 50%;
        }
        .profile-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* AVATAR SELECTION GRID */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg);
            border-radius: 15px;
        }
        .avatar-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid transparent;
            transition: 0.2s;
        }
        .avatar-option.selected {
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3);
        }

        /* SUPPORT SECTION */
        #support-section {
            margin-top: 25px;
        }
        .support-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border);
            transition: 0.2s;
            cursor: pointer;
        }
        .support-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        .support-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        .support-info {
            flex: 1;
        }
        .support-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        .support-desc {
            font-size: 0.85rem;
            color: var(--text-sec);
        }

        /* REVIEW PAGE */
        .review-question {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            background: var(--bg);
        }
        .review-correct {
            border-left: 4px solid var(--success);
        }
        .review-wrong {
            border-left: 4px solid var(--danger);
        }
        .review-skipped {
            border-left: 4px solid var(--warning);
        }

        /* FORGOT PASSWORD STYLES */
        .forgot-password-link {
            text-align: center;
            margin-top: 15px;
        }
        .forgot-password-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        .forgot-password-link a:hover {
            text-decoration: underline;
        }
        
        /* REGISTRATION PAGE ENHANCEMENTS */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .auth-card {
            width: 100%;
            max-width: 450px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .auth-title {
            text-align: center;
            color: var(--primary);
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        .auth-subtitle {
            text-align: center;
            color: var(--text-sec);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }
        
        /* EXAM SELECT DROPDOWN FOR LEADERBOARD */
        .exam-select-container {
            margin-bottom: 20px;
        }
        .exam-select-wrapper {
            position: relative;
            width: 100%;
        }
        .exam-select {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            transition: all 0.3s ease;
        }
        .exam-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }

        /* CONGRATULATIONS MESSAGE */
        .congratulations-message {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* CATEGORY FILTER STYLES */
        .category-filter {
            margin-bottom: 20px;
        }
        .category-select-wrapper {
            position: relative;
            width: 100%;
        }
        .category-select {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            transition: all 0.3s ease;
        }
        .category-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }

        /* ==================== */
        /* SMART STUDY PLAN CSS */
        /* ==================== */
        
        /* Motivational Carousel */
        .motivational-carousel {
            width: 100%;
            height: 120px;
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            background: var(--gradient-primary);
            box-shadow: var(--shadow);
        }
        
        .carousel-track {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease;
        }
        
        .carousel-slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            color: white;
            animation: fadeIn 1s ease;
        }
        
        .carousel-quote {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .carousel-author {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .carousel-indicators {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .carousel-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: 0.3s;
        }
        
        .carousel-indicator.active {
            background: white;
            transform: scale(1.2);
        }
        
        /* Level Selector */
        .level-selector-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .level-selector-card label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text);
        }
        
        .level-selector-card .level-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .level-selector-card .level-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }
        
        /* Journey Panel */
        .journey-panel {
            background: var(--gradient-secondary);
            color: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            animation: slideUp 0.5s ease;
        }
        
        .journey-goal {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .countdown-timer {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .countdown-item {
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            min-width: 60px;
        }
        
        .countdown-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }
        
        .countdown-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        /* Progress Cards */
        .progress-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .progress-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideUp 0.6s ease;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-title {
            font-weight: 600;
            color: var(--text);
        }
        
        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .progress-bar-container {
            height: 10px;
            background: var(--bg);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 5px;
            transition: width 1s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-sec);
        }
        
        /* Study Cards */
        .study-cards-container {
            margin-bottom: 20px;
        }
        
        .study-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .study-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .study-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: 0.3s;
            animation: slideUp 0.7s ease;
            position: relative;
            overflow: hidden;
        }
        
        .study-card.locked {
            opacity: 0.6;
            filter: grayscale(0.5);
        }
        
        .study-card.completed {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), var(--card-bg));
        }
        
        .study-card.in-progress {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(255, 165, 2, 0.1), var(--card-bg));
        }
        
        .study-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .study-day {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .study-status {
            font-size: 0.8rem;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .status-completed {
            background: var(--gradient-success);
            color: white;
        }
        
        .status-in-progress {
            background: var(--gradient-warning);
            color: white;
        }
        
        .status-pending {
            background: var(--text-sec);
            color: white;
        }
        
        .study-topic {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }
        
        .study-description {
            font-size: 0.9rem;
            color: var(--text-sec);
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .study-metrics {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.8rem;
        }
        
        .study-metric {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-sec);
        }
        
        .study-actions {
            display: flex;
            gap: 10px;
        }
        
        .read-again-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        /* Study Leaderboard */
        .study-leaderboard-tabs {
            display: flex;
            background: var(--bg);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 15px;
        }
        
        .study-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 500;
            transition: 0.2s;
        }
        
        .study-tab.active {
            background: var(--gradient-primary);
            color: white;
        }
        
        .study-leaderboard-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideUp 0.5s ease;
        }
        
        .study-rank {
            font-size: 1.2rem;
            font-weight: 700;
            width: 40px;
            text-align: center;
            color: var(--primary);
        }
        
        .study-user-info {
            flex: 1;
        }
        
        .study-user-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .study-user-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .study-user-progress-bar {
            flex: 1;
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .study-user-progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
        }
        
        .study-user-percentage {
            font-weight: 600;
            color: var(--primary);
            min-width: 45px;
            text-align: right;
        }

        /* Practice Quiz Modal */
        .practice-quiz-modal .modal-content {
            max-width: 500px;
        }
        
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .quiz-timer {
            background: var(--gradient-primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        /* ==================== */
        /* MEMORIZING PART CSS */
        /* ==================== */
        
        /* Memorizing Mode Selector */
        .memorizing-mode-selector {
            margin-bottom: 20px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 15px;
            box-shadow: var(--shadow);
            border: 2px solid var(--primary-light);
        }
        
        .mode-select-wrapper {
            position: relative;
            width: 100%;
        }
        
        .mode-select {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            transition: all 0.3s ease;
            background-color: var(--primary-light);
        }
        
        .mode-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.2);
        }
        
        /* Memorizing Category Selector */
        .memorizing-category-selector {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        .memorizing-category-selector-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }
        
        .category-select-dropdown {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236C63FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .category-select-dropdown:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15);
        }
        
        /* Memorizing Card Container */
        .memorizing-card-container {
            margin-bottom: 20px;
        }
        
        .memorizing-day-info {
            background: var(--gradient-secondary);
            color: white;
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .memorizing-day-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .memorizing-day-progress {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Memorizing Card */
        .memorizing-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border);
            transition: all 0.3s ease;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        
        .memorizing-card.red {
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), var(--card-bg));
            animation: pulseRed 2s infinite;
        }
        
        .memorizing-card.completed {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), var(--card-bg));
        }
        
        @keyframes pulseRed {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
        
        .memorizing-card-content {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            padding: 15px;
            line-height: 1.5;
            word-wrap: break-word;
            max-width: 100%;
        }
        
        .memorizing-card-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--gradient-primary);
            color: white;
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .memorizing-card-red-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--gradient-danger);
            color: white;
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }
        
        /* Memorizing Controls */
        .memorizing-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .memorizing-complete-btn {
            grid-column: 1 / -1;
            background: var(--gradient-success);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .memorizing-complete-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.4);
        }
        
        .memorizing-complete-btn:active {
            transform: translateY(0);
        }
        
        /* Memorizing Progress */
        .memorizing-progress-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .memorizing-progress-bar {
            height: 10px;
            background: var(--bg);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .memorizing-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        /* Memorizing Grid */
        .memorizing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .memorizing-grid-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            border: 2px solid var(--border);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
        }
        
        .memorizing-grid-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .memorizing-grid-card.red {
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), var(--card-bg));
        }
        
        .memorizing-grid-card.completed {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1), var(--card-bg));
        }
        
        /* Shimmer Effect */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .shimmer {
            background: linear-gradient(90deg, var(--bg) 25%, var(--card-bg) 50%, var(--bg) 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Animations */
        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .fade-in-left { animation: fadeInLeft 0.5s ease; }
        .bounce-in { animation: bounceIn 0.6s ease; }
        
        /* RANK PAGE STYLES */
        .rank-category-selector {
            margin-bottom: 20px;
        }
        
        .rank-leaderboard-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            animation: slideUp 0.5s ease;
        }
        
        .rank-number {
            font-size: 1.5rem;
            font-weight: 700;
            width: 50px;
            text-align: center;
            color: var(--primary);
        }
        
        .rank-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border);
        }
        
        .rank-user-info {
            flex: 1;
        }
        
        .rank-user-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .rank-user-stats {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-sec);
        }
        
        .rank-points {
            font-weight: 700;
            color: var(--primary);
            min-width: 80px;
            text-align: right;
        }
        
        /* PROFILE UPLOAD MODAL */
        #profile-upload-modal .modal-content {
            max-width: 400px;
        }
        
        .profile-upload-container {
            text-align: center;
            padding: 20px 0;
        }
        
        .profile-upload-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            border: 4px solid var(--border);
            overflow: hidden;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-upload-preview .placeholder {
            font-size: 3rem;
            color: var(--text-sec);
        }
        
        .profile-upload-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .upload-option-btn {
            padding: 15px;
            border-radius: 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
        }
        
        .upload-option-btn:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-3px);
        }
        
        .upload-option-btn i {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .upload-option-btn.gallery {
            color: var(--primary);
        }
        
        .upload-option-btn.camera {
            color: var(--success);
        }
        
        /* UPLOAD PROFILE PICTURE BUTTON */
        .upload-profile-btn {
            margin-top: 15px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .upload-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        /* ERROR MESSAGE POPUP */
        .error-message {
            background: var(--gradient-danger);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: bounceIn 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* CONGRATULATIONS COMPLETION MODAL */
        .completion-modal {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            animation: bounceIn 0.8s ease;
        }
        
        .completion-modal h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }
        
        .completion-modal p {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        /* RESULT BREAKDOWN STYLES */
        .result-breakdown {
            margin: 15px 0;
            padding: 15px;
            border-radius: 12px;
            background: var(--bg);
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .breakdown-item {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            background: var(--card-bg);
        }

        .breakdown-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
            margin-bottom: 3px;
        }

        .breakdown-label {
            font-size: 0.8rem;
            color: var(--text-sec);
        }

        .breakdown-correct .breakdown-value {
            color: var(--success);
        }

        .breakdown-wrong .breakdown-value {
            color: var(--danger);
        }

        .breakdown-skipped .breakdown-value {
            color: var(--warning);
        }

        .points-change {
            margin-top: 10px;
            padding: 8px 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }

        .points-change.positive {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
        }

        .points-change.negative {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
        }
    </style>
</head>
<body>

    <div id="refresh-indicator"><i class="fas fa-sync-alt fa-spin"></i></div>
    
    <!-- Network Status Popup -->
    <div id="network-status">
        <i class="fas fa-wifi-slash"></i> No internet connection. Please check your network.
    </div>

    <!-- Notification Popup -->
    <div class="notification-popup" id="notification-popup">
        <div class="notification-header">
            <h4 style="color: var(--primary); margin:0;">Notifications</h4>
            <i class="fas fa-times" onclick="closeNotificationPopup()" style="cursor:pointer;"></i>
        </div>
        <div id="notification-list"></div>
        <button class="notification-clear-all" onclick="clearAllNotifications()" id="clear-all-btn" style="display:none;">
            <i class="fas fa-trash"></i> Clear All
        </button>
    </div>

    <div id="splash-screen">
        <div class="splash-logo-container">
            <img src="13877.jpg" alt="Logo" class="splash-logo">
        </div>
        <div class="splash-text">ExamPro</div>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <div id="custom-alert">
        <h2 style="color:var(--primary); margin-bottom:10px;">ExamPro</h2>
        <p id="alert-msg" style="color:var(--text-sec); margin-bottom:20px; font-size:1rem;">Message</p>
        <button onclick="closeAlert()" class="btn btn-primary">OK</button>
    </div>

    <div id="confirm-modal">
        <div class="confirm-box">
            <i class="fas fa-exclamation-triangle confirm-icon"></i>
            <h3 style="margin-bottom:10px;">Are you sure?</h3>
            <p id="conf-msg" style="color:var(--text-sec); font-size:0.95rem;">This action cannot be undone.</p>
            <div class="confirm-btns">
                <button onclick="resolveConfirm(false)" class="btn btn-sec" style="margin-top:0;">Cancel</button>
                <button onclick="resolveConfirm(true)" class="btn btn-danger" style="margin-top:0;">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <h2 style="margin-bottom:20px; color:var(--primary);">Reset Password</h2>
            <p style="color:var(--text-sec); margin-bottom:15px;">Enter your email address and we'll send you a link to reset your password.</p>
            <input type="email" id="reset-email" placeholder="Email Address">
            <button onclick="sendPasswordResetEmail()" class="btn btn-primary">Send Reset Link</button>
            <button onclick="closeForgotPasswordModal()" class="btn btn-sec" style="margin-top:10px;">Cancel</button>
        </div>
    </div>

    <!-- Practice Quiz Modal -->
    <div id="practice-quiz-modal" class="modal practice-quiz-modal">
        <div class="modal-content">
            <div class="quiz-header">
                <h3 id="quiz-title" style="color:var(--primary); margin:0;">Practice Quiz</h3>
                <div class="quiz-timer" id="practice-quiz-timer">2:00</div>
            </div>
            <div id="practice-quiz-questions"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="submitPracticeQuiz()" class="btn btn-primary">Submit Quiz</button>
                <button onclick="closePracticeQuiz()" class="btn btn-sec">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Profile Upload Modal -->
    <div id="profile-upload-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px; color:var(--primary); text-align:center;">
                <i class="fas fa-camera"></i> Update Profile Picture
            </h2>
            
            <div class="profile-upload-container">
                <div class="profile-upload-preview">
                    <div class="placeholder" id="profile-upload-placeholder">
                        <i class="fas fa-user"></i>
                    </div>
                    <img id="profile-upload-preview-img" style="display:none;">
                </div>
                
                <div class="profile-upload-options">
                    <div class="upload-option-btn gallery" onclick="openGallery()">
                        <i class="fas fa-images"></i>
                        <div>Gallery</div>
                    </div>
                    <div class="upload-option-btn camera" onclick="openCamera()">
                        <i class="fas fa-camera"></i>
                        <div>Camera</div>
                    </div>
                </div>
                
                <div id="profile-upload-instructions" style="margin-top:15px; color:var(--text-sec); font-size:0.9rem;">
                    Select a photo from your gallery or take a new one
                </div>
                
                <input type="file" id="profile-upload-input" accept="image/*" style="display:none;">
                
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button onclick="uploadProfilePicture()" class="btn btn-primary" id="profile-upload-btn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> Upload
                    </button>
                    <button onclick="closeProfileUploadModal()" class="btn btn-sec">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <section id="auth-screen" class="screen">
        <div class="auth-container" style="background:var(--gradient-primary);">
            <div class="auth-card">
                <h1 class="auth-title">ExamPro</h1>
                <p class="auth-subtitle">Login to continue your learning journey</p>
                
                <div id="login-form">
                    <input type="email" id="l-email" placeholder="Email Address">
                    <input type="password" id="l-pass" placeholder="Password">
                    <button onclick="handleLogin()" class="btn btn-primary">Log In</button>
                    
                    <div class="forgot-password-link">
                        <a onclick="showForgotPasswordModal()">Forgot Password?</a>
                    </div>
                    
                    <p style="margin-top:20px; color:var(--text-sec); text-align:center;">
                        New User? 
                        <b onclick="toggleAuth('signup')" style="color:var(--primary); cursor:pointer; font-weight:600;">
                            Create Account
                        </b>
                    </p>
                </div>

                <div id="signup-form" style="display:none;">
                    <input type="text" id="s-name" placeholder="Full Name">
                    <select id="s-gender">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input type="text" id="s-edu" placeholder="Education (e.g. HSC)">
                    <input type="email" id="s-email" placeholder="Email Address">
                    <input type="password" id="s-pass" placeholder="Password (minimum 6 characters)">
                    <button onclick="handleSignup()" class="btn btn-primary">Create Account</button>
                    
                    <p style="margin-top:20px; color:var(--text-sec); text-align:center;">
                        Already have an account? 
                        <b onclick="toggleAuth('login')" style="color:var(--primary); cursor:pointer; font-weight:600;">
                            Log In
                        </b>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section id="app-screen" class="screen">
        <header>
            <div class="logo">ExamPro</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <i onclick="toggleNotificationPopup()" class="fas fa-bell" id="notification-icon" style="font-size:1.4rem; cursor:pointer; color:var(--white); position:relative;">
                    <span id="notification-count" style="display:none; position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; border-radius:50%; width:18px; height:18px; font-size:0.6rem; display:flex; align-items:center; justify-content:center;">0</span>
                </i>
                <i onclick="toggleTheme()" id="theme-icon" class="fas fa-moon" style="font-size:1.4rem; cursor:pointer;"></i>
            </div>
        </header>

        <div id="main-content" class="container"></div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="renderHome()"><i class="fas fa-home"></i> <span>Home</span></div>
            <div class="nav-item" onclick="renderStudy()"><i class="fas fa-book-open"></i> <span>Study</span></div>
            <div class="nav-item" onclick="renderRank()"><i class="fas fa-trophy"></i> <span>Rank</span></div>
            <div class="nav-item" onclick="renderReview()"><i class="fas fa-clipboard-check"></i> <span>Review</span></div>
            <div class="nav-item" onclick="renderProfile()"><i class="fas fa-user"></i> <span>Profile</span></div>
        </nav>
    </section>

    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom:20px; color:var(--primary);">Title</h2>
            <div id="modal-body"></div>
            <button onclick="closeModal()" class="btn btn-sec" style="margin-top:20px;">Close</button>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px; color:var(--primary); text-align:center;">
                <i class="fas fa-share-alt"></i> Share ExamPro
            </h2>
            <div class="share-options">
                <div class="share-option-btn telegram-btn" onclick="shareViaPlatform('telegram')">
                    <i class="fab fa-telegram"></i>
                    <div>
                        <div style="font-weight:600;">Telegram Bot</div>
                        <small style="color:var(--text-sec);">Share via Telegram bot</small>
                    </div>
                </div>
                <div class="share-option-btn website-btn" onclick="shareViaPlatform('website')">
                    <i class="fas fa-globe"></i>
                    <div>
                        <div style="font-weight:600;">Website</div>
                        <small style="color:var(--text-sec);">Share website link</small>
                    </div>
                </div>
                <div class="share-option-btn app-btn" onclick="shareViaPlatform('app')">
                    <i class="fas fa-mobile-alt"></i>
                    <div>
                        <div style="font-weight:600;">App</div>
                        <small style="color:var(--text-sec);">Share app download link</small>
                    </div>
                </div>
            </div>
            <button onclick="closeShareModal()" class="btn btn-sec" style="margin-top:20px;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, deleteDoc, updateDoc, onSnapshot, Timestamp, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBW0-UiTB83ikUOztrT6ECAkOlnzxykKYQ",
            authDomain: "mcq-exam-b150e.firebaseapp.com",
            projectId: "mcq-exam-b150e",
            storageBucket: "mcq-exam-b150e.firebasestorage.app",
            messagingSenderId: "751727102033",
            appId: "1:751727102033:web:35995f15619e300872d070",
            measurementId: "G-9NS51NRGER"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let timerInterval;
        let allStudentsCache = [];
        let allNotifications = [];
        let unreadNotifications = 0;
        let selectedCategory = localStorage.getItem('selectedCategory') || '';
        let allCategories = [];
        
        // Smart Study Plan Variables
        let studyProgress = null;
        let studyLevels = [];
        let currentStudyLevel = 1;
        let motivationalQuotes = [];
        let studySettings = null;
        let carouselInterval = null;
        let currentCarouselIndex = 0;
        let practiceQuizQuestions = [];
        let practiceQuizAnswers = {};
        let practiceQuizTimer = null;
        let practiceQuizTimeLeft = 120;
        let currentPracticeDay = null;
        let currentPracticeLevel = null;

        // Memorizing Variables
        let memorizingCategories = [];
        let memorizingCards = [];
        let currentMemorizingCategory = null;
        let currentMemorizingDay = 1;
        let userMemorizingProgress = {};
        let redCards = [];
        let currentMemorizingMode = 'study-plan';
        let currentCardsSet = [];
        let allCategoryCards = [];
        let cardsPerSet = 10;

        // Rank Page Variables
        let rankCategory = '';
        let rankLeaderboard = [];

        // Slider Variables
        let homeSlides = [];
        let currentSlideIndex = 0;
        let slideInterval = null;

        // Profile Upload Variables
        let profileImageFile = null;
        let profileImagePreviewUrl = null;

        // AVATAR IMAGES
        const AVATAR_MALE = [
            "https://cdn-icons-png.flaticon.com/512/4825/4825038.png",
            "https://cdn-icons-png.flaticon.com/512/4333/4333609.png",
            "https://cdn-icons-png.flaticon.com/512/4140/4140047.png",
            "https://cdn-icons-png.flaticon.com/512/4322/4322992.png",
            "https://cdn-icons-png.flaticon.com/512/3135/3135715.png",
            "https://cdn-icons-png.flaticon.com/512/921/921071.png"
        ];
        
        const AVATAR_FEMALE = [
            "https://cdn-icons-png.flaticon.com/512/4825/4825112.png",
            "https://cdn-icons-png.flaticon.com/512/6997/6997662.png",
            "https://cdn-icons-png.flaticon.com/512/4140/4140037.png",
            "https://cdn-icons-png.flaticon.com/512/4322/4322991.png",
            "https://cdn-icons-png.flaticon.com/512/3135/3135782.png",
            "https://cdn-icons-png.flaticon.com/512/921/921124.png"
        ];

        // Default Motivational Quotes
        const DEFAULT_QUOTES = [
            { quote: "The secret of getting ahead is getting started.", author: "Mark Twain" },
            { quote: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
            { quote: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
            { quote: "Education is the most powerful weapon which you can use to change the world.", author: "Nelson Mandela" },
            { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { quote: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" }
        ];

        // SHARE LINKS DEFAULT
        let shareLinks = {
            telegram: "https://t.me/your_bot",
            website: "https://yourexampro.com",
            app: "https://play.google.com/store/apps/details?id=com.exampro"
        };

        // SUPPORT LINKS
        let supportLinks = [];

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: 'dsmvmq076',
            uploadPreset: 'my_app_upload',
            apiKey: '137218329783741'
        };

        // --- NETWORK CONNECTIVITY ---
        function updateNetworkStatus() {
            const networkStatus = document.getElementById('network-status');
            if (!navigator.onLine) {
                networkStatus.style.display = 'block';
            } else {
                networkStatus.style.display = 'none';
            }
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        updateNetworkStatus();

        // --- SPLASH SCREEN LOGIC ---
        function hideSplash() {
            const splash = document.getElementById('splash-screen');
            if(splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 600);
            }
        }

        // --- PULL TO REFRESH LOGIC ---
        let touchStart = 0;
        let touchEnd = 0;
        const refInd = document.getElementById('refresh-indicator');
        
        window.addEventListener('touchstart', e => {
            if(window.scrollY === 0) touchStart = e.changedTouches[0].screenY;
        }, {passive: true});

        window.addEventListener('touchmove', e => {
            if(window.scrollY === 0 && touchStart > 0) {
                touchEnd = e.changedTouches[0].screenY;
                if(touchEnd > touchStart) {
                    const pull = Math.min((touchEnd - touchStart) * 0.4, 80); 
                    refInd.style.top = `${pull}px`;
                }
            }
        }, {passive: true});

        window.addEventListener('touchend', e => {
            if(window.scrollY === 0 && touchStart > 0) {
                touchEnd = e.changedTouches[0].screenY;
                if(touchEnd - touchStart > 120) { 
                    refInd.style.top = '20px';
                    setTimeout(() => location.reload(), 300);
                } else {
                    refInd.style.top = '-50px'; 
                }
            }
            touchStart = 0;
        }, {passive: true});

        // --- CUSTOM CONFIRM LOGIC ---
        let confirmResolver = null;
        window.customConfirm = (msg) => {
            const m = document.getElementById('confirm-modal');
            document.getElementById('conf-msg').innerText = msg;
            m.classList.add('active'); 
            return new Promise((resolve) => {
                confirmResolver = resolve;
            });
        }
        window.resolveConfirm = (val) => {
            const m = document.getElementById('confirm-modal');
            m.classList.remove('active');
            if(confirmResolver) confirmResolver(val);
        }

        // --- UTILS ---
        window.showMsg = (msg, type = 'info') => {
            if (type === 'error') {
                document.getElementById('alert-msg').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        ${msg}
                    </div>
                `;
            } else {
                document.getElementById('alert-msg').innerText = msg;
            }
            document.getElementById('custom-alert').classList.add('show');
        }
        
        window.closeAlert = () => document.getElementById('custom-alert').classList.remove('show');
        
        window.toggleTheme = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            
            // Update gradient based on theme
            if (isDark) {
                document.documentElement.style.setProperty('--gradient-primary', 'var(--night-gradient-header)');
                document.documentElement.style.setProperty('--gradient-secondary', 'var(--night-gradient-card)');
            } else {
                document.documentElement.style.setProperty('--gradient-primary', 'var(--day-gradient-header)');
                document.documentElement.style.setProperty('--gradient-secondary', 'var(--day-gradient-card)');
            }
        }
        
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').className = 'fas fa-sun';
            document.documentElement.style.setProperty('--gradient-primary', 'var(--night-gradient-header)');
            document.documentElement.style.setProperty('--gradient-secondary', 'var(--night-gradient-card)');
        } else {
            document.documentElement.style.setProperty('--gradient-primary', 'var(--day-gradient-header)');
            document.documentElement.style.setProperty('--gradient-secondary', 'var(--day-gradient-card)');
        }

        // --- FORGOT PASSWORD FUNCTIONS ---
        window.showForgotPasswordModal = () => {
            document.getElementById('forgot-password-modal').style.display = 'flex';
        }

        window.closeForgotPasswordModal = () => {
            document.getElementById('forgot-password-modal').style.display = 'none';
        }

        window.sendPasswordResetEmail = async () => {
            const email = document.getElementById('reset-email').value;
            if(!email) return showMsg("Please enter your email");
            try {
                toggleLoader(true);
                await sendPasswordResetEmail(auth, email);
                showMsg("Password reset email sent! Check your inbox.");
                closeForgotPasswordModal();
            } catch(e) {
                showMsg(e.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        // --- SHARE FUNCTIONS ---
        window.showShareOptions = () => {
            document.getElementById('share-modal').style.display = 'flex';
        }

        window.closeShareModal = () => {
            document.getElementById('share-modal').style.display = 'none';
        }

        window.shareViaPlatform = async (platform) => {
            const shareLinksSnap = await getDoc(doc(db, "settings", "shareLinks"));
            if (shareLinksSnap.exists()) {
                shareLinks = shareLinksSnap.data();
            }
            
            let shareUrl = "";
            let platformName = "";
            
            switch(platform) {
                case 'telegram':
                    shareUrl = shareLinks.telegram || "https://t.me/your_bot";
                    platformName = "Telegram Bot";
                    break;
                case 'website':
                    shareUrl = shareLinks.website || "https://yourexampro.com";
                    platformName = "Website";
                    break;
                case 'app':
                    shareUrl = shareLinks.app || "https://play.google.com/store/apps/details?id=com.exampro";
                    platformName = "App";
                    break;
            }
            
            const shareText = `Hey! Check out ExamPro - the best exam preparation app! Join me using this ${platformName} link: ${shareUrl}`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'ExamPro',
                        text: shareText,
                        url: shareUrl,
                    });
                } catch (err) {
                    copyToClipboard(shareText);
                }
            } else {
                copyToClipboard(shareText);
            }
            
            closeShareModal();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMsg("Link copied to clipboard! Share it with your friends.");
            });
        }

        window.showProfileUploadModal = () => {
            closeModal();
            document.getElementById('profile-upload-modal').style.display = 'flex';
            resetProfileUploadModal();
        }

        window.closeProfileUploadModal = () => {
            document.getElementById('profile-upload-modal').style.display = 'none';
            resetProfileUploadModal();
        }

        function resetProfileUploadModal() {
            profileImageFile = null;
            profileImagePreviewUrl = null;
            
            const previewImg = document.getElementById('profile-upload-preview-img');
            const placeholder = document.getElementById('profile-upload-placeholder');
            const uploadBtn = document.getElementById('profile-upload-btn');
            
            previewImg.style.display = 'none';
            previewImg.src = '';
            placeholder.style.display = 'flex';
            uploadBtn.disabled = true;
            
            document.getElementById('profile-upload-input').value = '';
        }

        window.openGallery = () => {
            document.getElementById('profile-upload-input').click();
        }

        window.openCamera = () => {
            const input = document.getElementById('profile-upload-input');
            input.setAttribute('capture', 'environment');
            input.click();
        }

        // Handle file selection
        document.getElementById('profile-upload-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleProfileImageSelect(file);
            }
        });

        function handleProfileImageSelect(file) {
            if (!file.type.match('image.*')) {
                showMsg("Please select an image file", 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showMsg("Image size should be less than 5MB", 'error');
                return;
            }

            profileImageFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                profileImagePreviewUrl = e.target.result;
                
                const previewImg = document.getElementById('profile-upload-preview-img');
                const placeholder = document.getElementById('profile-upload-placeholder');
                const uploadBtn = document.getElementById('profile-upload-btn');
                
                previewImg.src = profileImagePreviewUrl;
                previewImg.style.display = 'block';
                placeholder.style.display = 'none';
                uploadBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        window.uploadProfilePicture = async () => {
            if (!profileImageFile) {
                showMsg("Please select an image first", 'error');
                return;
            }

            try {
                toggleLoader(true);
                
                // Upload to Cloudinary
                const formData = new FormData();
                formData.append('file', profileImageFile);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);
                formData.append('cloud_name', cloudinaryConfig.cloudName);
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.secure_url) {
                    // Update profile picture in Firebase
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        avatar: data.secure_url
                    });
                    
                    // Update current user data
                    currentUser.avatar = data.secure_url;
                    
                    // Update profile picture immediately
                    const profileAvatarImg = document.getElementById('profile-avatar-img');
                    if (profileAvatarImg) {
                        profileAvatarImg.src = data.secure_url;
                    }
                    
                    showMsg("Profile picture updated successfully!");
                    closeProfileUploadModal();
                } else {
                    throw new Error("Failed to upload image");
                }
            } catch(error) {
                console.error("Error uploading profile picture:", error);
                showMsg("Error uploading profile picture: " + error.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        // --- SLIDER FUNCTIONS ---
        async function loadHomeSlides() {
            try {
                const snap = await getDocs(collection(db, "homeSlides"));
                homeSlides = [];
                snap.forEach(doc => {
                    homeSlides.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by order or createdAt
                homeSlides.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                return homeSlides;
            } catch(error) {
                console.error("Error loading slides:", error);
                return [];
            }
        }

        function renderHomeSlider() {
            if (!homeSlides.length) return '';
            
            let slidesHTML = '';
            let indicatorsHTML = '';
            
            homeSlides.forEach((slide, index) => {
                slidesHTML += `
                    <div class="slide">
                        <a href="${slide.link || '#'}" target="_blank">
                            <img src="${slide.imageUrl}" class="slide-image" alt="${slide.title || 'Slide'}">
                            ${slide.title ? `
                                <div class="slide-overlay">
                                    <div class="slide-title">${slide.title}</div>
                                    ${slide.description ? `<div class="slide-desc">${slide.description}</div>` : ''}
                                </div>
                            ` : ''}
                        </a>
                    </div>
                `;
                
                indicatorsHTML += `<div class="slide-indicator ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index})"></div>`;
            });
            
            return `
                <div class="slides-container">
                    <div class="slides-track" id="slides-track">
                        ${slidesHTML}
                    </div>
                    <div class="slide-nav prev" onclick="prevSlide()">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <div class="slide-nav next" onclick="nextSlide()">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="slide-indicators">
                        ${indicatorsHTML}
                    </div>
                </div>
            `;
        }

        function startSlider() {
            if (slideInterval) clearInterval(slideInterval);
            if (homeSlides.length <= 1) return;
            
            slideInterval = setInterval(() => {
                nextSlide();
            }, 5000);
        }

        window.goToSlide = (index) => {
            currentSlideIndex = index;
            updateSlider();
            if (slideInterval) {
                clearInterval(slideInterval);
                slideInterval = setInterval(() => {
                    nextSlide();
                }, 5000);
            }
        }

        window.nextSlide = () => {
            if (homeSlides.length <= 1) return;
            currentSlideIndex = (currentSlideIndex + 1) % homeSlides.length;
            updateSlider();
        }

        window.prevSlide = () => {
            if (homeSlides.length <= 1) return;
            currentSlideIndex = (currentSlideIndex - 1 + homeSlides.length) % homeSlides.length;
            updateSlider();
        }

        function updateSlider() {
            const track = document.getElementById('slides-track');
            const indicators = document.querySelectorAll('.slide-indicator');
            
            if (track) {
                track.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
            }
            
            indicators.forEach((indicator, index) => {
                if (index === currentSlideIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        // --- NOTIFICATION FUNCTIONS ---
        function showNotificationPopup(title, message) {
            const popup = document.getElementById('notification-popup');
            popup.style.display = 'block';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 5000);
        }

        window.toggleNotificationPopup = () => {
            const popup = document.getElementById('notification-popup');
            if(popup.style.display === 'block') {
                popup.style.display = 'none';
            } else {
                loadNotifications();
                popup.style.display = 'block';
            }
        }

        window.closeNotificationPopup = () => {
            document.getElementById('notification-popup').style.display = 'none';
        }

        async function loadNotifications() {
            try {
                const q = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
                const snap = await getDocs(q);
                
                allNotifications = [];
                unreadNotifications = 0;
                snap.forEach(doc => {
                    const notif = { id: doc.id, ...doc.data() };
                    allNotifications.push(notif);
                    if(!notif.read) unreadNotifications++;
                });
                
                allNotifications.sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());
                
                updateNotificationUI();
            } catch(error) {
                console.error("Error loading notifications:", error);
            }
        }

        function updateNotificationUI() {
            const list = document.getElementById('notification-list');
            const countElem = document.getElementById('notification-count');
            const clearAllBtn = document.getElementById('clear-all-btn');
            
            if(allNotifications.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-sec); padding:10px;">No notifications</p>';
                clearAllBtn.style.display = 'none';
            } else {
                let html = '';
                allNotifications.forEach(notif => {
                    const icon = getNotificationIcon(notif.type);
                    const time = formatTime(notif.timestamp?.toMillis() || Date.now());
                    html += `
                        <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markAsRead('${notif.id}')">
                            <div class="notification-item-content">
                                <div style="display:flex; gap:10px;">
                                    <i class="fas ${icon}" style="color:var(--primary);"></i>
                                    <div>
                                        <div style="font-weight:600;">${notif.title}</div>
                                        <div style="font-size:0.8rem; color:var(--text-sec);">${notif.message}</div>
                                        <div style="font-size:0.7rem; color:var(--text-sec); margin-top:3px;">${time}</div>
                                    </div>
                                </div>
                            </div>
                            <button class="notification-delete" onclick="deleteNotification('${notif.id}', event)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                });
                list.innerHTML = html;
                clearAllBtn.style.display = 'block';
            }
            
            if(unreadNotifications > 0) {
                countElem.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
                countElem.style.display = 'flex';
            } else {
                countElem.style.display = 'none';
            }
        }

        window.deleteNotification = async (notificationId, event) => {
            if (event) event.stopPropagation();
            await deleteDoc(doc(db, "notifications", notificationId));
            loadNotifications();
        }

        window.clearAllNotifications = async () => {
            if(await customConfirm("Clear all notifications?")) {
                const q = query(collection(db, "notifications"), where("userId", "==", currentUser.uid));
                const snap = await getDocs(q);
                
                const batch = writeBatch(db);
                snap.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                loadNotifications();
                showMsg("All notifications cleared!");
            }
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'exam': return 'fa-file-alt';
                case 'routine': return 'fa-calendar';
                case 'note': return 'fa-book';
                case 'broadcast': return 'fa-bullhorn';
                case 'support': return 'fa-headset';
                default: return 'fa-bell';
            }
        }

        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if(diff < 60000) return 'Just now';
            if(diff < 3600000) return `${Math.floor(diff/60000)} min ago`;
            if(diff < 86400000) return `${Math.floor(diff/3600000)} hour ago`;
            return `${Math.floor(diff/86400000)} day ago`;
        }

        async function markAsRead(notificationId) {
            await updateDoc(doc(db, "notifications", notificationId), { read: true });
            loadNotifications();
        }

        async function sendNotification(userId, title, message, type = 'general') {
            await addDoc(collection(db, "notifications"), {
                userId: userId,
                title: title,
                message: message,
                type: type,
                read: false,
                timestamp: Timestamp.now()
            });
        }

        // --- LOAD SUPPORT LINKS ---
        async function loadSupportLinks() {
            const snap = await getDocs(collection(db, "supportLinks"));
            supportLinks = [];
            snap.forEach(doc => {
                supportLinks.push({ id: doc.id, ...doc.data() });
            });
            supportLinks.sort((a, b) => (a.order || 0) - (b.order || 0));
        }

        // --- RENDER SUPPORT SECTION ---
        function renderSupportSection() {
            if (supportLinks.length === 0) return '';
            
            let html = `
                <div id="support-section">
                    <h3 style="margin-bottom:15px; color:var(--text); display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-headset" style="color:var(--primary)"></i> Support & Contact
                    </h3>`;
            
            supportLinks.forEach(link => {
                const iconColor = link.color || '#6C63FF';
                html += `
                    <div class="support-card" onclick="window.open('${link.link}', '_blank')">
                        <div class="support-icon" style="background: ${iconColor}">
                            <i class="${link.icon}"></i>
                        </div>
                        <div class="support-info">
                            <div class="support-title">${link.title}</div>
                            <div class="support-desc">${link.description || 'Click to connect'}</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color:var(--text-sec);"></i>
                    </div>
                `;
            });
            
            html += `</div>`;
            return html;
        }

        // --- CATEGORY FUNCTIONS ---
        async function loadAllCategories() {
            try {
                const categoriesSnap = await getDocs(collection(db, "categories"));
                const categoriesSet = new Set();
                
                categoriesSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.name) {
                        categoriesSet.add(data.name);
                    }
                });
                
                const examsSnap = await getDocs(collection(db, "exams"));
                examsSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.category) {
                        categoriesSet.add(data.category);
                    }
                });
                
                allCategories = Array.from(categoriesSet).sort();
                return allCategories;
            } catch(error) {
                console.error("Error loading categories:", error);
                return [];
            }
        }

        // --- MEMORIZING FUNCTIONS ---
        async function loadMemorizingData() {
            if (!currentUser) return;
            
            try {
                // Load memorizing categories
                const categoriesSnap = await getDocs(collection(db, "memorizingCategories"));
                memorizingCategories = [];
                categoriesSnap.forEach(doc => {
                    memorizingCategories.push({ id: doc.id, ...doc.data() });
                });
                
                // Load user progress
                const progressSnap = await getDoc(doc(db, "userMemorizingProgress", currentUser.uid));
                if (progressSnap.exists()) {
                    userMemorizingProgress = progressSnap.data();
                } else {
                    userMemorizingProgress = {
                        userId: currentUser.uid,
                        categories: {}
                    };
                    await setDoc(doc(db, "userMemorizingProgress", currentUser.uid), userMemorizingProgress);
                }
                
            } catch(error) {
                console.error("Error loading memorizing data:", error);
            }
        }

        async function loadMemorizingCardsForCategory(categoryId) {
            try {
                const q = query(collection(db, "memorizingCards"), where("categoryId", "==", categoryId));
                const snap = await getDocs(q);
                
                allCategoryCards = [];
                snap.forEach(doc => {
                    allCategoryCards.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by day
                allCategoryCards.sort((a, b) => a.day - b.day);
                
                return allCategoryCards;
            } catch(error) {
                console.error("Error loading memorizing cards:", error);
                return [];
            }
        }

        async function getCurrentMemorizingCards() {
            if (!currentMemorizingCategory) {
                return [];
            }

            // Initialize category progress if not exists
            if (!userMemorizingProgress.categories[currentMemorizingCategory]) {
                userMemorizingProgress.categories[currentMemorizingCategory] = {
                    currentDay: 1,
                    redCards: [],
                    completedCards: [],
                    lastStudied: new Date().toISOString()
                };
            }
            
            const categoryProgress = userMemorizingProgress.categories[currentMemorizingCategory];
            currentMemorizingDay = categoryProgress.currentDay || 1;
            redCards = categoryProgress.redCards || [];
            
            // Get cards for current day (10 cards per day)
            const startIndex = (currentMemorizingDay - 1) * cardsPerSet;
            const endIndex = startIndex + cardsPerSet;
            
            let dayCards = allCategoryCards.slice(startIndex, endIndex);
            
            // Add red cards from previous days
            const redCardObjects = allCategoryCards.filter(card => 
                redCards.includes(card.id)
            );
            
            // Combine and limit to 10 cards
            let allCards = [...redCardObjects, ...dayCards];
            if (allCards.length > cardsPerSet) {
                allCards = allCards.slice(0, cardsPerSet);
            }
            
            currentCardsSet = allCards;
            return currentCardsSet;
        }

        async function updateMemorizingProgress(completed = false) {
            if (!currentUser || !currentMemorizingCategory) return;
            
            try {
                if (!userMemorizingProgress.categories[currentMemorizingCategory]) {
                    userMemorizingProgress.categories[currentMemorizingCategory] = {
                        currentDay: 1,
                        redCards: [],
                        completedCards: [],
                        lastStudied: new Date().toISOString()
                    };
                }
                
                const categoryProgress = userMemorizingProgress.categories[currentMemorizingCategory];
                
                if (completed) {
                    // Move to next day
                    categoryProgress.currentDay += 1;
                    
                    // Reset red cards for the new day (they will be added to the next set)
                    categoryProgress.redCards = [];
                } else {
                    // Update red cards
                    categoryProgress.redCards = redCards;
                }
                
                categoryProgress.lastStudied = new Date().toISOString();
                
                await setDoc(doc(db, "userMemorizingProgress", currentUser.uid), userMemorizingProgress, { merge: true });
                
            } catch(error) {
                console.error("Error updating memorizing progress:", error);
            }
        }

        async function toggleCardRed(cardId) {
            const index = redCards.indexOf(cardId);
            if (index > -1) {
                redCards.splice(index, 1);
            } else {
                redCards.push(cardId);
            }
            
            await updateMemorizingProgress(false);
        }

        // Calculate overall progress for memorizing category
        function calculateMemorizingCategoryProgress() {
            if (!currentMemorizingCategory || !allCategoryCards.length) {
                return { progress: 0, totalCards: 0, completedCards: 0 };
            }
            
            const categoryProgress = userMemorizingProgress.categories[currentMemorizingCategory] || {};
            const currentDay = categoryProgress.currentDay || 1;
            
            // Calculate progress based on days completed
            const totalDays = Math.ceil(allCategoryCards.length / cardsPerSet);
            const progress = Math.min(((currentDay - 1) / totalDays) * 100, 100);
            
            return {
                progress: Math.round(progress),
                totalCards: allCategoryCards.length,
                completedCards: Math.min((currentDay - 1) * cardsPerSet, allCategoryCards.length)
            };
        }

        // --- STUDY PAGE ---
        window.renderStudy = async () => {
            updateNav(1);
            
            await loadStudyData();
            await loadMemorizingData();
            
            const countdown = calculateCountdown();
            
            document.getElementById('main-content').innerHTML = `
                <div class="memorizing-mode-selector">
                    <div class="mode-select-wrapper">
                        <select id="study-mode" class="mode-select" onchange="changeStudyMode(this.value)">
                            <option value="study-plan" ${currentMemorizingMode === 'study-plan' ? 'selected' : ''}>
                                 Study Plan
                            </option>
                            <option value="memorizing-part" ${currentMemorizingMode === 'memorizing-part' ? 'selected' : ''}>
                                 Memorizing Part
                            </option>
                        </select>
                    </div>
                </div>
                
                <div id="study-plan-section" style="display: ${currentMemorizingMode === 'study-plan' ? 'block' : 'none'};">
                    <div class="level-selector-card">
                        <label for="study-level-select">Select Study Level</label>
                        <select class="level-select" id="study-level-select" onchange="changeStudyLevel(this.value)">
                            <option value="">Select Level</option>
                            ${studyLevels.map(level => 
                                `<option value="${level.level}" ${level.level === currentStudyLevel ? 'selected' : ''}>
                                    Level ${level.level}${level.title ? `: ${level.title}` : ''}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="motivational-carousel">
                        <div class="carousel-track" id="carousel-track"></div>
                        <div class="carousel-indicators" id="carousel-indicators">
                            ${motivationalQuotes.map((_, index) => 
                                `<div class="carousel-indicator ${index === 0 ? 'active' : ''}" onclick="goToSlide(${index})"></div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="journey-panel">
                        <div class="journey-goal">
                            <i class="fas fa-flag-checkered"></i>
                            ${studySettings ? studySettings.goalName : 'Complete Smart Study Plan'}
                        </div>
                        <p style="opacity:0.9; margin-bottom:15px;">Target Deadline: ${studySettings ? new Date(studySettings.targetDeadline).toLocaleDateString() : 'Not set'}</p>
                        
                        <div class="countdown-timer">
                            <div class="countdown-item">
                                <span class="countdown-value" id="countdown-days">${countdown.days}</span>
                                <span class="countdown-label">Days</span>
                            </div>
                            <div class="countdown-item">
                                <span class="countdown-value" id="countdown-hours">${countdown.hours}</span>
                                <span class="countdown-label">Hours</span>
                            </div>
                            <div class="countdown-item">
                                <span class="countdown-value" id="countdown-minutes">${countdown.minutes}</span>
                                <span class="countdown-label">Minutes</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-cards">
                        <div class="progress-card">
                            <div class="progress-header">
                                <div class="progress-title">Total Study Progress</div>
                                <div class="progress-percentage">${studyProgress ? studyProgress.totalProgress : 0}%</div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${studyProgress ? studyProgress.totalProgress : 0}%"></div>
                            </div>
                            <div class="progress-stats">
                                <span>${studyProgress ? studyProgress.completedTopics.length : 0} Topics Completed</span>
                                <span>${studyProgress ? studyProgress.totalStudyTime : 0} min</span>
                            </div>
                        </div>
                        
                        <div class="progress-card">
                            <div class="progress-header">
                                <div class="progress-title">Daily Study Progress</div>
                                <div class="progress-percentage">${studyProgress ? studyProgress.dailyProgress : 0}%</div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${studyProgress ? studyProgress.dailyProgress : 0}%"></div>
                            </div>
                            <div class="progress-stats">
                                <span>Today's Goal</span>
                                <span>${studyProgress ? studyProgress.dailyStudyTime : 0}/${studySettings ? studySettings.dailyGoal : 60} min</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="study-cards-container" id="study-cards-container">
                        <h3 class="study-section-title">
                            <i class="fas fa-calendar-day"></i>
                            Study Plan - Level ${currentStudyLevel}
                        </h3>
                        <div id="study-cards-grid" class="study-cards-grid">
                            Loading study content...
                        </div>
                    </div>
                    
                    <div class="study-leaderboard-tabs">
                        <div class="study-tab active" onclick="showStudyLeaderboard('daily')">Daily Leaderboard</div>
                        <div class="study-tab" onclick="showStudyLeaderboard('total')">Total Leaderboard</div>
                    </div>
                    
                    <div id="study-leaderboard">
                        Loading leaderboard...
                    </div>
                </div>
                
                <div id="memorizing-part-section" style="display: ${currentMemorizingMode === 'memorizing-part' ? 'block' : 'none'};">
                    ${renderMemorizingPart()}
                </div>
            `;
            
            if (currentMemorizingMode === 'study-plan') {
                startMotivationalCarousel();
                startCountdownTimer();
                await loadStudyCards();
                await loadStudyLeaderboard('daily');
            } else {
                await renderMemorizingCategorySelector();
            }
        }

        window.changeStudyMode = async (mode) => {
            currentMemorizingMode = mode;
            await renderStudy();
        }

        function renderMemorizingPart() {
            return `
                <div class="memorizing-category-selector" id="memorizing-category-selector">
                    <div class="memorizing-category-selector-card">
                        <h3><i class="fas fa-brain"></i> Memorizing Part</h3>
                        <p style="opacity:0.9; margin-bottom:15px;">Select a category to start memorizing words or sentences</p>
                        
                        <select class="category-select-dropdown" id="memorizing-category-dropdown" onchange="selectMemorizingCategory(this.value)">
                            <option value="">Select a Category</option>
                            ${memorizingCategories.map(category => 
                                `<option value="${category.id}">${category.name}</option>`
                            ).join('')}
                        </select>
                        
                        <div id="category-info" style="display:none;">
                            <div class="memorizing-day-info">
                                <div class="memorizing-day-title" id="memorizing-day-title">Day 1</div>
                                <div class="memorizing-day-progress" id="memorizing-day-progress">10 cards to study</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="memorizing-content" style="display: none;">
                    <div class="memorizing-progress-container">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Overall Progress</span>
                            <span id="memorizing-progress-text">0/0 (0%)</span>
                        </div>
                        <div class="memorizing-progress-bar">
                            <div class="memorizing-progress-fill" id="memorizing-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="memorizing-cards-container">
                        <div class="shimmer" style="height:200px; border-radius:20px; margin-bottom:15px;"></div>
                    </div>
                    
                    <div class="memorizing-controls">
                        <button onclick="showAllMemorizingCards()" class="btn btn-primary">
                            <i class="fas fa-th"></i> View All Cards
                        </button>
                        <button onclick="resetMemorizingCategory()" class="btn btn-warning">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        <button onclick="completeMemorizingDay()" class="memorizing-complete-btn" id="complete-btn">
                            <i class="fas fa-check-circle"></i> Complete Day
                        </button>
                    </div>
                </div>
                
                <div id="all-cards-modal" style="display:none;">
                    <div class="card">
                        <h3 style="margin-bottom:15px;">All Cards - Day ${currentMemorizingDay}</h3>
                        <div id="all-cards-grid" class="memorizing-grid"></div>
                        <button onclick="hideAllCards()" class="btn btn-sec" style="margin-top:15px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
        }

        async function renderMemorizingCategorySelector() {
            const dropdown = document.getElementById('memorizing-category-dropdown');
            if (!dropdown) return;
            
            if (memorizingCategories.length === 0) {
                document.getElementById('memorizing-category-selector').innerHTML = `
                    <div class="memorizing-category-selector-card">
                        <div style="text-align:center; padding:20px;">
                            <i class="fas fa-book" style="font-size:3rem; color:var(--text-sec); margin-bottom:15px;"></i>
                            <h3>No Memorizing Categories</h3>
                            <p style="color:var(--text-sec); margin-top:10px;">Categories will be added by admin.</p>
                        </div>
                    </div>
                `;
                return;
            }
        }

        window.selectMemorizingCategory = async (categoryId) => {
            if (!categoryId) return;
            
            currentMemorizingCategory = categoryId;
            const cards = await loadMemorizingCardsForCategory(categoryId);
            
            if (cards.length === 0) {
                showMsg("No cards found for this category.");
                return;
            }
            
            document.getElementById('category-info').style.display = 'block';
            document.getElementById('memorizing-content').style.display = 'block';
            
            await loadCurrentMemorizingCards();
        }

        async function loadCurrentMemorizingCards() {
            const cards = await getCurrentMemorizingCards();
            const container = document.getElementById('memorizing-cards-container');
            
            if (!cards || cards.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align:center; padding:40px;">
                        <i class="fas fa-book" style="font-size:3rem; color:var(--text-sec); margin-bottom:15px;"></i>
                        <h3>No Cards Available</h3>
                        <p style="color:var(--text-sec); margin-top:10px;">No cards found for this category and day.</p>
                    </div>
                `;
                return;
            }
            
            // Update day info
            const categoryProgress = userMemorizingProgress.categories[currentMemorizingCategory] || {};
            const currentDay = categoryProgress.currentDay || 1;
            
            document.getElementById('memorizing-day-title').textContent = `Day ${currentDay}`;
            document.getElementById('memorizing-day-progress').textContent = `${cards.length} cards to study`;
            
            // Calculate and update overall progress
            const overallProgress = calculateMemorizingCategoryProgress();
            document.getElementById('memorizing-progress-text').textContent = 
                `${overallProgress.completedCards}/${overallProgress.totalCards} (${overallProgress.progress}%)`;
            document.getElementById('memorizing-progress-fill').style.width = `${overallProgress.progress}%`;
            
            // Render cards
            let html = '';
            cards.forEach((card, index) => {
                const isRed = redCards.includes(card.id);
                
                html += `
                    <div class="memorizing-card ${isRed ? 'red' : ''}" 
                         ondblclick="toggleMemorizingCardRed('${card.id}')"
                         style="animation-delay: ${index * 0.1}s">
                        ${isRed ? '<div class="memorizing-card-red-badge"><i class="fas fa-redo"></i> Review</div>' : ''}
                        <div class="memorizing-card-badge">${index + 1}/${cards.length}</div>
                        <div class="memorizing-card-content">${card.content}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Update complete button
            const completeBtn = document.getElementById('complete-btn');
            if (cards.length === 0) {
                completeBtn.disabled = true;
                completeBtn.innerHTML = '<i class="fas fa-check-circle"></i> No Cards Available';
            } else {
                completeBtn.disabled = false;
                completeBtn.innerHTML = `<i class="fas fa-check-circle"></i> Complete Day ${currentDay}`;
            }
        }

        window.toggleMemorizingCardRed = async (cardId) => {
            await toggleCardRed(cardId);
            await loadCurrentMemorizingCards();
            showMsg("Card marked for review! It will appear in the next set.");
        }

        window.completeMemorizingDay = async () => {
            openModal(" Congratulations!", `
                <div class="completion-modal">
                    <h3>Day ${currentMemorizingDay} Completed!</h3>
                    <p>Great job! You've successfully completed Day ${currentMemorizingDay}.</p>
                    <p>Ready to move to the next set of cards?</p>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button onclick="proceedToNextDay()" class="btn btn-success" style="flex:1;">
                            <i class="fas fa-arrow-right"></i> Next Day
                        </button>
                        <button onclick="closeModal()" class="btn btn-sec" style="flex:1;">
                            <i class="fas fa-times"></i> Stay Here
                        </button>
                    </div>
                </div>
            `);
        }

        window.proceedToNextDay = async () => {
            closeModal();
            await updateMemorizingProgress(true);
            await loadCurrentMemorizingCards();
            showMsg("Moving to next set of cards!");
        }

        window.showAllMemorizingCards = async () => {
            const cards = currentCardsSet;
            const grid = document.getElementById('all-cards-grid');
            
            let html = '';
            cards.forEach((card, index) => {
                const isRed = redCards.includes(card.id);
                const shortContent = card.content.length > 30 ? card.content.substring(0, 30) + '...' : card.content;
                
                html += `
                    <div class="memorizing-grid-card ${isRed ? 'red' : ''}" 
                         ondblclick="toggleMemorizingCardRed('${card.id}')">
                        <div style="font-weight:600; margin-bottom:5px;">Card ${index + 1}</div>
                        <div style="font-size:0.9rem;">${shortContent}</div>
                        ${isRed ? '<div style="font-size:0.7rem; color:var(--danger); margin-top:5px;"><i class="fas fa-redo"></i> Review</div>' : ''}
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            document.getElementById('all-cards-modal').style.display = 'block';
        }

        window.hideAllCards = () => {
            document.getElementById('all-cards-modal').style.display = 'none';
        }

        window.resetMemorizingCategory = async () => {
            if (await customConfirm("Reset progress for this category? This will reset to Day 1.")) {
                if (userMemorizingProgress.categories[currentMemorizingCategory]) {
                    userMemorizingProgress.categories[currentMemorizingCategory] = {
                        currentDay: 1,
                        redCards: [],
                        completedCards: [],
                        lastStudied: new Date().toISOString()
                    };
                    
                    await setDoc(doc(db, "userMemorizingProgress", currentUser.uid), userMemorizingProgress, { merge: true });
                    await loadCurrentMemorizingCards();
                    showMsg("Category progress reset!");
                }
            }
        }

        // --- SMART STUDY PLAN FUNCTIONS ---
        async function loadStudyData() {
            if (!currentUser) return;
            
            try {
                const progressSnap = await getDoc(doc(db, "Userstudy", currentUser.uid));
                if (progressSnap.exists()) {
                    studyProgress = progressSnap.data();
                } else {
                    studyProgress = {
                        userId: currentUser.uid,
                        level: 1,
                        dailyProgress: 0,
                        totalProgress: 0,
                        completedTopics: [],
                        lastStudyDate: new Date().toISOString().split('T')[0],
                        dailyStudyTime: 0,
                        totalStudyTime: 0
                    };
                    await setDoc(doc(db, "Userstudy", currentUser.uid), studyProgress);
                }
                
                const levelsSnap = await getDocs(collection(db, "StudyLevels"));
                studyLevels = [];
                levelsSnap.forEach(doc => {
                    studyLevels.push({ id: doc.id, ...doc.data() });
                });
                
                studyLevels.sort((a, b) => a.level - b.level);
                
                const quotesSnap = await getDocs(collection(db, "MotivationalQuotes"));
                if (!quotesSnap.empty) {
                    motivationalQuotes = [];
                    quotesSnap.forEach(doc => {
                        motivationalQuotes.push(doc.data());
                    });
                } else {
                    motivationalQuotes = DEFAULT_QUOTES;
                }
                
                const settingsSnap = await getDoc(doc(db, "StudySettings", "global"));
                if (settingsSnap.exists()) {
                    studySettings = settingsSnap.data();
                } else {
                    studySettings = {
                        goalName: "Complete Smart Study Plan",
                        targetDeadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        dailyGoal: 60,
                        totalGoal: 1800
                    };
                    await setDoc(doc(db, "StudySettings", "global"), studySettings);
                }
                
            } catch(error) {
                console.error("Error loading study data:", error);
            }
        }

        async function updateStudyProgress(completedDay = null) {
            if (!currentUser || !studyProgress) return;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                if (studyProgress.lastStudyDate !== today) {
                    studyProgress.dailyProgress = 0;
                    studyProgress.lastStudyDate = today;
                }
                
                if (completedDay) {
                    const dayKey = `Level${currentStudyLevel}_Day${completedDay}`;
                    if (!studyProgress.completedTopics.includes(dayKey)) {
                        studyProgress.completedTopics.push(dayKey);
                        
                        const totalDays = studyLevels.reduce((total, level) => total + (level.days || 0), 0);
                        studyProgress.totalProgress = Math.round((studyProgress.completedTopics.length / totalDays) * 100);
                        
                        studyProgress.dailyStudyTime += 30;
                        studyProgress.totalStudyTime += 30;
                        
                        studyProgress.dailyProgress = Math.round((studyProgress.dailyStudyTime / studySettings.dailyGoal) * 100);
                    }
                }
                
                await setDoc(doc(db, "Userstudy", currentUser.uid), studyProgress, { merge: true });
                
            } catch(error) {
                console.error("Error updating study progress:", error);
            }
        }

        function startMotivationalCarousel() {
            if (carouselInterval) {
                clearInterval(carouselInterval);
            }
            
            const track = document.getElementById('carousel-track');
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            if (!track || motivationalQuotes.length === 0) return;
            
            let html = '';
            motivationalQuotes.forEach((quote, index) => {
                html += `
                    <div class="carousel-slide">
                        <div class="carousel-quote">"${quote.quote}"</div>
                        <div class="carousel-author">- ${quote.author}</div>
                    </div>
                `;
            });
            track.innerHTML = html;
            
            carouselInterval = setInterval(() => {
                currentCarouselIndex = (currentCarouselIndex + 1) % motivationalQuotes.length;
                updateCarousel();
            }, 5000);
        }

        function updateCarousel() {
            const track = document.getElementById('carousel-track');
            const indicators = document.querySelectorAll('.carousel-indicator');
            
            if (track) {
                track.style.transform = `translateX(-${currentCarouselIndex * 100}%)`;
            }
            
            indicators.forEach((indicator, index) => {
                if (index === currentCarouselIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        function calculateCountdown() {
            if (!studySettings || !studySettings.targetDeadline) {
                return { days: 0, hours: 0, minutes: 0 };
            }
            
            const deadline = new Date(studySettings.targetDeadline);
            const now = new Date();
            const diff = deadline - now;
            
            if (diff <= 0) {
                return { days: 0, hours: 0, minutes: 0 };
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            return { days, hours, minutes };
        }

        window.goToSlide = (index) => {
            currentCarouselIndex = index;
            updateCarousel();
            if (carouselInterval) {
                clearInterval(carouselInterval);
                carouselInterval = setInterval(() => {
                    currentCarouselIndex = (currentCarouselIndex + 1) % motivationalQuotes.length;
                    updateCarousel();
                }, 5000);
            }
        }

        function startCountdownTimer() {
            setInterval(() => {
                const countdown = calculateCountdown();
                const daysElem = document.getElementById('countdown-days');
                const hoursElem = document.getElementById('countdown-hours');
                const minutesElem = document.getElementById('countdown-minutes');
                
                if (daysElem) daysElem.textContent = countdown.days;
                if (hoursElem) hoursElem.textContent = countdown.hours;
                if (minutesElem) minutesElem.textContent = countdown.minutes;
            }, 60000);
        }

        window.changeStudyLevel = async (level) => {
            currentStudyLevel = parseInt(level);
            await loadStudyCards();
        }

        async function loadStudyCards() {
            try {
                const grid = document.getElementById('study-cards-grid');
                if (!grid) return;
                
                grid.innerHTML = '<div class="shimmer" style="height:200px; border-radius:15px;"></div>';
                
                const q = query(
                    collection(db, "StudyContent"), 
                    where("level", "==", currentStudyLevel)
                );
                const snap = await getDocs(q);
                
                let studyDays = [];
                snap.forEach(doc => {
                    studyDays.push({ id: doc.id, ...doc.data() });
                });
                
                studyDays.sort((a, b) => a.day - b.day);
                
                if (studyDays.length === 0) {
                    grid.innerHTML = `
                        <div class="card" style="grid-column: 1 / -1; text-align:center; padding:40px;">
                            <i class="fas fa-book" style="font-size:3rem; color:var(--text-sec); margin-bottom:15px;"></i>
                            <h3>No Study Content Available</h3>
                            <p style="color:var(--text-sec); margin-top:10px;">Study content for Level ${currentStudyLevel} will be added soon.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                studyDays.forEach(day => {
                    const dayKey = `Level${currentStudyLevel}_Day${day.day}`;
                    const isCompleted = studyProgress.completedTopics.includes(dayKey);
                    const isLocked = day.day > 1 && !studyProgress.completedTopics.includes(`Level${currentStudyLevel}_Day${day.day - 1}`);
                    
                    html += `
                        <div class="study-card ${isCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''}" 
                             style="animation-delay: ${day.day * 0.1}s">
                            <div class="study-card-header">
                                <div class="study-day">Day ${day.day}</div>
                                <div class="study-status ${isCompleted ? 'status-completed' : (isLocked ? 'status-pending' : 'status-in-progress')}">
                                    ${isCompleted ? 'Completed' : (isLocked ? 'Locked' : 'Available')}
                                </div>
                            </div>
                            
                            <div class="study-topic">${day.topic || 'Study Topic'}</div>
                            <div class="study-description">${day.description || 'No description available.'}</div>
                            
                            <div class="study-metrics">
                                <div class="study-metric">
                                    <i class="fas fa-clock"></i>
                                    <span>${day.duration || 30} min</span>
                                </div>
                                <div class="study-metric">
                                    <i class="fas fa-question-circle"></i>
                                    <span>${day.mcqCount || 10} MCQs</span>
                                </div>
                            </div>
                            
                            ${!isLocked ? `
                                <div class="study-actions">
                                    <button onclick="startPracticeQuiz(${currentStudyLevel}, ${day.day})" 
                                            class="btn ${isCompleted ? 'btn-success' : 'btn-primary'}" 
                                            style="flex:1;">
                                        <i class="fas fa-play-circle"></i> ${isCompleted ? 'Practice Again' : 'Practice'}
                                    </button>
                                </div>
                                
                                ${!isCompleted ? `
                                    <div class="read-again-checkbox" id="read-again-${day.day}">
                                        <input type="checkbox" id="checkbox-${day.day}" onchange="toggleReadAgain(${day.day})">
                                        <label for="checkbox-${day.day}">Need to read again</label>
                                    </div>
                                ` : ''}
                            ` : `
                                <div class="study-actions">
                                    <button class="btn btn-sec" style="flex:1;" disabled>
                                        <i class="fas fa-lock"></i> Complete Day ${day.day - 1} to unlock
                                    </button>
                                </div>
                            `}
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
                
            } catch(error) {
                console.error("Error loading study cards:", error);
                document.getElementById('study-cards-grid').innerHTML = `
                    <div class="card" style="grid-column: 1 / -1; text-align:center; padding:20px; color:var(--danger);">
                        Error loading study content. Please try again.
                    </div>
                `;
            }
        }

        window.toggleReadAgain = (day) => {
            const checkbox = document.getElementById(`checkbox-${day}`);
            const button = document.querySelector(`.study-card:nth-child(${day}) .study-actions button`);
            
            if (checkbox.checked) {
                button.innerHTML = '<i class="fas fa-redo"></i> Reset Practice';
                button.classList.remove('btn-primary');
                button.classList.add('btn-warning');
                button.onclick = () => resetPractice(day);
            } else {
                button.innerHTML = '<i class="fas fa-play-circle"></i> Practice';
                button.classList.remove('btn-warning');
                button.classList.add('btn-primary');
                button.onclick = () => startPracticeQuiz(currentStudyLevel, day);
            }
        }

        window.resetPractice = (day) => {
            const dayKey = `Level${currentStudyLevel}_Day${day}`;
            const index = studyProgress.completedTopics.indexOf(dayKey);
            if (index > -1) {
                studyProgress.completedTopics.splice(index, 1);
                updateStudyProgress();
                loadStudyCards();
                showMsg("Practice reset successfully! You can now practice again.");
            }
        }

        window.startPracticeQuiz = async (level, day) => {
            currentPracticeLevel = level;
            currentPracticeDay = day;
            
            try {
                const q = query(
                    collection(db, "PracticeQuestions"),
                    where("level", "==", level),
                    where("day", "==", day)
                );
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    showMsg("No practice questions available for this day.");
                    return;
                }
                
                practiceQuizQuestions = [];
                snap.forEach(doc => {
                    practiceQuizQuestions.push({ id: doc.id, ...doc.data() });
                });
                
                practiceQuizQuestions = practiceQuizQuestions
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 10);
                
                practiceQuizAnswers = {};
                practiceQuizTimeLeft = 120;
                
                document.getElementById('quiz-title').textContent = `Practice Quiz - Level ${level} Day ${day}`;
                document.getElementById('practice-quiz-modal').style.display = 'flex';
                
                renderPracticeQuestions();
                startPracticeTimer();
                
            } catch(error) {
                console.error("Error loading practice questions:", error);
                // ... [Continuing from where the code cut off] ...
showMsg("Error loading practice questions: " + error.message, 'error');
            }
        }

        window.startPracticeQuiz = async (level, day) => {
            currentPracticeLevel = level;
            currentPracticeDay = day;
            
            try {
                toggleLoader(true);
                
                // Load practice questions
                const q = query(
                    collection(db, "PracticeQuestions"),
                    where("level", "==", level),
                    where("day", "==", day)
                );
                const snap = await getDocs(q);
                
                practiceQuizQuestions = [];
                snap.forEach(doc => {
                    practiceQuizQuestions.push({ id: doc.id, ...doc.data() });
                });
                
                if (practiceQuizQuestions.length === 0) {
                    showMsg("No practice questions available for this day.");
                    return;
                }
                
                // Shuffle and limit to 10 questions
                practiceQuizQuestions = practiceQuizQuestions
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 10);
                
                // Reset answers and timer
                practiceQuizAnswers = {};
                practiceQuizTimeLeft = 120; // 2 minutes
                
                // Show modal
                document.getElementById('practice-quiz-modal').style.display = 'flex';
                document.getElementById('quiz-title').textContent = `Practice Quiz - Level ${level} Day ${day}`;
                
                // Render questions
                renderPracticeQuestions();
                
                // Start timer
                startPracticeTimer();
                
            } catch(error) {
                console.error("Error loading practice questions:", error);
                showMsg("Error loading practice questions.", 'error');
            } finally {
                toggleLoader(false);
            }
        }

        function renderPracticeQuestions() {
            const container = document.getElementById('practice-quiz-questions');
            let html = '';
            
            practiceQuizQuestions.forEach((question, index) => {
                html += `
                    <div class="mcq-anim" style="animation-delay: ${index * 0.1}s; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;">
                            <span style="background: var(--primary); color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; margin-right: 10px;">Q${index + 1}</span>
                            <span style="font-weight: 600;">${question.question}</span>
                        </div>
                        
                        <div class="mcq-option ${practiceQuizAnswers[question.id] === 'a' ? 'selected' : ''}" onclick="selectPracticeAnswer('${question.id}', 'a')">
                            <div class="mcq-circle"></div>
                            <span>A) ${question.optionA}</span>
                        </div>
                        <div class="mcq-option ${practiceQuizAnswers[question.id] === 'b' ? 'selected' : ''}" onclick="selectPracticeAnswer('${question.id}', 'b')">
                            <div class="mcq-circle"></div>
                            <span>B) ${question.optionB}</span>
                        </div>
                        <div class="mcq-option ${practiceQuizAnswers[question.id] === 'c' ? 'selected' : ''}" onclick="selectPracticeAnswer('${question.id}', 'c')">
                            <div class="mcq-circle"></div>
                            <span>C) ${question.optionC}</span>
                        </div>
                        <div class="mcq-option ${practiceQuizAnswers[question.id] === 'd' ? 'selected' : ''}" onclick="selectPracticeAnswer('${question.id}', 'd')">
                            <div class="mcq-circle"></div>
                            <span>D) ${question.optionD}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        window.selectPracticeAnswer = (questionId, answer) => {
            practiceQuizAnswers[questionId] = answer;
            
            // Update UI
            const questionIndex = practiceQuizQuestions.findIndex(q => q.id === questionId);
            const questionContainer = document.querySelectorAll('.mcq-anim')[questionIndex];
            
            // Remove selected from all options
            questionContainer.querySelectorAll('.mcq-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selected to chosen option
            const optionDivs = questionContainer.querySelectorAll('.mcq-option');
            const optionIndex = ['a', 'b', 'c', 'd'].indexOf(answer);
            if (optionDivs[optionIndex]) {
                optionDivs[optionIndex].classList.add('selected');
            }
        }

        function startPracticeTimer() {
            if (practiceQuizTimer) clearInterval(practiceQuizTimer);
            
            practiceQuizTimer = setInterval(() => {
                practiceQuizTimeLeft--;
                
                const minutes = Math.floor(practiceQuizTimeLeft / 60);
                const seconds = practiceQuizTimeLeft % 60;
                document.getElementById('practice-quiz-timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (practiceQuizTimeLeft <= 0) {
                    clearInterval(practiceQuizTimer);
                    submitPracticeQuiz();
                }
            }, 1000);
        }

        window.submitPracticeQuiz = async () => {
            if (practiceQuizTimer) {
                clearInterval(practiceQuizTimer);
            }
            
            // Calculate score
            let correct = 0;
            let total = practiceQuizQuestions.length;
            
            practiceQuizQuestions.forEach(question => {
                const userAnswer = practiceQuizAnswers[question.id];
                if (userAnswer === question.correctAnswer) {
                    correct++;
                }
            });
            
            const score = Math.round((correct / total) * 100);
            
            // Show result
            openModal("Quiz Result", `
                <div class="result-breakdown">
                    <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary);">
                        Practice Quiz Result
                    </h3>
                    
                    <div class="breakdown-grid">
                        <div class="breakdown-item breakdown-correct">
                            <span class="breakdown-value">${correct}</span>
                            <span class="breakdown-label">Correct</span>
                        </div>
                        <div class="breakdown-item breakdown-wrong">
                            <span class="breakdown-value">${total - correct}</span>
                            <span class="breakdown-label">Wrong</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-value">${score}%</span>
                            <span class="breakdown-label">Score</span>
                        </div>
                    </div>
                    
                    ${score >= 70 ? `
                        <div class="points-change positive" style="margin-top: 15px;">
                            <i class="fas fa-check-circle"></i> Day ${currentPracticeDay} marked as completed!
                        </div>
                    ` : `
                        <div class="points-change negative" style="margin-top: 15px;">
                            <i class="fas fa-exclamation-circle"></i> Score below 70%. Try again to complete this day.
                        </div>
                    `}
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="reviewPracticeQuiz()" class="btn btn-primary" style="margin-bottom: 10px;">
                        <i class="fas fa-eye"></i> Review Answers
                    </button>
                    <button onclick="closePracticeQuiz()" class="btn btn-sec">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `);
            
            // Update study progress if score is above threshold
            if (score >= 70 && currentPracticeLevel && currentPracticeDay) {
                const dayKey = `Level${currentPracticeLevel}_Day${currentPracticeDay}`;
                if (!studyProgress.completedTopics.includes(dayKey)) {
                    studyProgress.completedTopics.push(dayKey);
                    await updateStudyProgress(currentPracticeDay);
                    await loadStudyCards();
                }
            }
        }

        window.reviewPracticeQuiz = () => {
            closeModal();
            
            let reviewHtml = '<h3 style="margin-bottom: 20px; color: var(--primary);">Quiz Review</h3>';
            
            practiceQuizQuestions.forEach((question, index) => {
                const userAnswer = practiceQuizAnswers[question.id];
                const isCorrect = userAnswer === question.correctAnswer;
                const correctAnswerText = question['option' + question.correctAnswer.toUpperCase()];
                
                reviewHtml += `
                    <div class="review-question ${isCorrect ? 'review-correct' : 'review-wrong'}" style="margin-bottom: 15px;">
                        <div style="font-weight: 600; margin-bottom: 10px;">Q${index + 1}: ${question.question}</div>
                        
                        <div style="margin-bottom: 5px;">
                            <strong>Your Answer:</strong> ${userAnswer ? question['option' + userAnswer.toUpperCase()] : 'Not answered'}
                            ${isCorrect ? 
                                '<span style="color: var(--success); margin-left: 10px;"><i class="fas fa-check"></i> Correct</span>' : 
                                '<span style="color: var(--danger); margin-left: 10px;"><i class="fas fa-times"></i> Wrong</span>'
                            }
                        </div>
                        
                        ${!isCorrect ? `
                            <div style="margin-bottom: 5px;">
                                <strong>Correct Answer:</strong> ${correctAnswerText}
                            </div>
                        ` : ''}
                        
                        ${question.explanation ? `
                            <div style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 8px;">
                                <strong>Explanation:</strong> ${question.explanation}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            openModal("Quiz Review", reviewHtml);
        }

        window.closePracticeQuiz = () => {
            document.getElementById('practice-quiz-modal').style.display = 'none';
            
            if (practiceQuizTimer) {
                clearInterval(practiceQuizTimer);
                practiceQuizTimer = null;
            }
            
            practiceQuizQuestions = [];
            practiceQuizAnswers = {};
            practiceQuizTimeLeft = 120;
        }

        window.showStudyLeaderboard = async (type = 'daily') => {
            try {
                const leaderboardElem = document.getElementById('study-leaderboard');
                leaderboardElem.innerHTML = '<div class="shimmer" style="height: 100px; border-radius: 15px;"></div>';
                
                // Update tab styles
                document.querySelectorAll('.study-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                let q;
                if (type === 'daily') {
                    const today = new Date().toISOString().split('T')[0];
                    q = query(
                        collection(db, "Userstudy"),
                        where("lastStudyDate", "==", today),
                        orderBy("dailyStudyTime", "desc")
                    );
                } else {
                    q = query(
                        collection(db, "Userstudy"),
                        orderBy("totalProgress", "desc")
                    );
                }
                
                const snap = await getDocs(q);
                const leaderboardData = [];
                
                for (const docSnap of snap.docs) {
                    const data = docSnap.data();
                    const userSnap = await getDoc(doc(db, "users", docSnap.id));
                    
                    if (userSnap.exists()) {
                        leaderboardData.push({
                            ...data,
                            id: docSnap.id,
                            name: userSnap.data().name,
                            avatar: userSnap.data().avatar
                        });
                    }
                }
                
                let html = '';
                leaderboardData.forEach((user, index) => {
                    const isCurrentUser = user.id === currentUser.uid;
                    
                    html += `
                        <div class="study-leaderboard-card ${isCurrentUser ? 'current-user-card' : ''}" style="animation-delay: ${index * 0.1}s">
                            <div class="study-rank">#${index + 1}</div>
                            
                            <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden;">
                                <img src="${user.avatar || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" 
                                     alt="${user.name}" 
                                     style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            
                            <div class="study-user-info">
                                <div class="study-user-name">${user.name}</div>
                                <div class="study-user-progress">
                                    <div class="study-user-progress-bar">
                                        <div class="study-user-progress-fill" 
                                             style="width: ${type === 'daily' ? user.dailyProgress || 0 : user.totalProgress || 0}%">
                                        </div>
                                    </div>
                                    <div class="study-user-percentage">
                                        ${type === 'daily' ? (user.dailyProgress || 0) : (user.totalProgress || 0)}%
                                    </div>
                                </div>
                            </div>
                            
                            <div style="font-weight: 600; color: var(--primary); min-width: 60px; text-align: right;">
                                ${type === 'daily' ? (user.dailyStudyTime || 0) : (user.totalStudyTime || 0)}m
                            </div>
                        </div>
                    `;
                });
                
                leaderboardElem.innerHTML = html;
                
            } catch(error) {
                console.error("Error loading study leaderboard:", error);
                document.getElementById('study-leaderboard').innerHTML = `
                    <div class="card" style="text-align: center; padding: 20px; color: var(--text-sec);">
                        Error loading leaderboard. Please try again.
                    </div>
                `;
            }
        }

        // --- RANK PAGE FUNCTIONS ---
        window.renderRank = async () => {
            updateNav(2);
            
            await loadAllCategories();
            
            if (rankCategory === '' && allCategories.length > 0) {
                rankCategory = allCategories[0];
            }
            
            document.getElementById('main-content').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h2 style="display: flex; align-items: center; gap: 10px; color: var(--text); margin-bottom: 15px;">
                        <i class="fas fa-trophy" style="color: var(--warning);"></i>
                        Leaderboard
                    </h2>
                    
                    <div class="rank-category-selector">
                        <div class="exam-select-wrapper">
                            <select id="rank-category-select" class="exam-select" onchange="changeRankCategory(this.value)">
                                ${allCategories.map(cat => 
                                    `<option value="${cat}" ${cat === rankCategory ? 'selected' : ''}>${cat}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="rank-leaderboard">
                    Loading leaderboard...
                </div>
            `;
            
            await loadRankLeaderboard();
        }

        window.changeRankCategory = async (category) => {
            rankCategory = category;
            await loadRankLeaderboard();
        }

        async function loadRankLeaderboard() {
            try {
                const leaderboardElem = document.getElementById('rank-leaderboard');
                leaderboardElem.innerHTML = '<div class="shimmer" style="height: 100px; border-radius: 15px;"></div>';
                
                // Get all users
                const usersSnap = await getDocs(collection(db, "users"));
                const users = [];
                
                for (const docSnap of usersSnap.docs) {
                    const userData = docSnap.data();
                    const resultsSnap = await getDocs(
                        query(
                            collection(db, "results"),
                            where("userId", "==", docSnap.id)
                        )
                    );
                    
                    let totalScore = 0;
                    let totalExams = 0;
                    
                    resultsSnap.forEach(resultDoc => {
                        const result = resultDoc.data();
                        if (result.category === rankCategory) {
                            totalScore += result.score || 0;
                            totalExams++;
                        }
                    });
                    
                    const averageScore = totalExams > 0 ? totalScore / totalExams : 0;
                    
                    users.push({
                        id: docSnap.id,
                        name: userData.name,
                        avatar: userData.avatar,
                        averageScore: averageScore,
                        totalExams: totalExams
                    });
                }
                
                // Sort by average score
                users.sort((a, b) => b.averageScore - a.averageScore);
                
                // Get current user's rank
                const currentUserIndex = users.findIndex(user => user.id === currentUser.uid);
                const currentUserRank = currentUserIndex >= 0 ? currentUserIndex + 1 : users.length + 1;
                
                let html = `
                    <div class="card" style="margin-bottom: 20px; background: var(--gradient-primary); color: white; text-align: center;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px;">Your Rank in ${rankCategory}</div>
                        <div style="font-size: 2.5rem; font-weight: 700;">#${currentUserRank}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            ${users[currentUserIndex]?.averageScore?.toFixed(1) || '0'} Average Score
                        </div>
                    </div>
                `;
                
                // Display top 20
                users.slice(0, 20).forEach((user, index) => {
                    const isCurrentUser = user.id === currentUser.uid;
                    
                    html += `
                        <div class="rank-leaderboard-card ${isCurrentUser ? 'current-user-card' : ''}" style="animation-delay: ${index * 0.1}s">
                            <div class="rank-number">
                                ${index < 3 ? 
                                    ['', '', ''][index] : 
                                    `#${index + 1}`
                                }
                            </div>
                            
                            <img src="${user.avatar || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" 
                                 class="rank-avatar" 
                                 alt="${user.name}">
                            
                            <div class="rank-user-info">
                                <div class="rank-user-name">${user.name}</div>
                                <div class="rank-user-stats">
                                    <span>Avg: ${user.averageScore.toFixed(1)}</span>
                                    <span></span>
                                    <span>Exams: ${user.totalExams}</span>
                                </div>
                            </div>
                            
                            <div class="rank-points">
                                ${user.averageScore.toFixed(1)}
                            </div>
                        </div>
                    `;
                });
                
                leaderboardElem.innerHTML = html;
                
            } catch(error) {
                console.error("Error loading rank leaderboard:", error);
                document.getElementById('rank-leaderboard').innerHTML = `
                    <div class="card" style="text-align: center; padding: 20px; color: var(--text-sec);">
                        Error loading leaderboard. Please try again.
                    </div>
                `;
            }
        }

        // --- REVIEW PAGE FUNCTIONS ---
        window.renderReview = () => {
            updateNav(3);
            
            document.getElementById('main-content').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h2 style="display: flex; align-items: center; gap: 10px; color: var(--text); margin-bottom: 15px;">
                        <i class="fas fa-clipboard-check" style="color: var(--success);"></i>
                        Review & History
                    </h2>
                </div>
                
                <div class="category-filter">
                    <div class="exam-select-wrapper">
                        <select id="review-category-select" class="category-select" onchange="loadReviewHistory()">
                            <option value="all">All Categories</option>
                            ${allCategories.map(cat => 
                                `<option value="${cat}">${cat}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <div id="review-history">
                    Loading your history...
                </div>
            `;
            
            loadReviewHistory();
        }

        async function loadReviewHistory() {
            try {
                const category = document.getElementById('review-category-select').value;
                const historyElem = document.getElementById('review-history');
                historyElem.innerHTML = '<div class="shimmer" style="height: 100px; border-radius: 15px;"></div>';
                
                let q;
                if (category === 'all') {
                    q = query(
                        collection(db, "results"),
                        where("userId", "==", currentUser.uid),
                        orderBy("timestamp", "desc")
                    );
                } else {
                    q = query(
                        collection(db, "results"),
                        where("userId", "==", currentUser.uid),
                        where("category", "==", category),
                        orderBy("timestamp", "desc")
                    );
                }
                
                const snap = await getDocs(q);
                const results = [];
                
                snap.forEach(doc => {
                    results.push({ id: doc.id, ...doc.data() });
                });
                
                if (results.length === 0) {
                    historyElem.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <i class="fas fa-history" style="font-size: 3rem; color: var(--text-sec); margin-bottom: 15px;"></i>
                            <h3>No History Found</h3>
                            <p style="color: var(--text-sec); margin-top: 10px;">
                                You haven't taken any exams yet. Start practicing!
                            </p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                results.forEach(result => {
                    const date = result.timestamp?.toDate ? result.timestamp.toDate() : new Date();
                    const percentage = result.percentage || 0;
                    
                    let cardClass = '';
                    if (percentage >= 70) cardClass = 'result-card-green';
                    else if (percentage >= 50) cardClass = 'result-card-medium';
                    else cardClass = 'result-card-red';
                    
                    html += `
                        <div class="card ${cardClass}" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0; color: var(--text);">${result.examName || 'Exam'}</h4>
                                    <small style="color: var(--text-sec);">
                                        ${result.category || 'General'}  
                                        ${date.toLocaleDateString()}  
                                        ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </small>
                                </div>
                                
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: ${percentage >= 70 ? 'var(--success)' : percentage >= 50 ? 'var(--warning)' : 'var(--danger)'}">
                                        ${percentage.toFixed(1)}%
                                    </div>
                                    <small style="color: var(--text-sec);">Score: ${result.score || 0}/${result.total || 0}</small>
                                </div>
                            </div>
                            
                            <div class="result-breakdown">
                                <div class="breakdown-grid">
                                    <div class="breakdown-item breakdown-correct">
                                        <span class="breakdown-value">${result.correct || 0}</span>
                                        <span class="breakdown-label">Correct</span>
                                    </div>
                                    <div class="breakdown-item breakdown-wrong">
                                        <span class="breakdown-value">${result.wrong || 0}</span>
                                        <span class="breakdown-label">Wrong</span>
                                    </div>
                                    <div class="breakdown-item">
                                        <span class="breakdown-value">${result.timeTaken ? Math.floor(result.timeTaken / 60) + 'm' + (result.timeTaken % 60) + 's' : 'N/A'}</span>
                                        <span class="breakdown-label">Time</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="reviewExamResult('${result.id}')" class="btn btn-sec" style="margin-top: 15px;">
                                <i class="fas fa-eye"></i> Review Answers
                            </button>
                        </div>
                    `;
                });
                
                historyElem.innerHTML = html;
                
            } catch(error) {
                console.error("Error loading review history:", error);
                document.getElementById('review-history').innerHTML = `
                    <div class="card" style="text-align: center; padding: 20px; color: var(--text-sec);">
                        Error loading history. Please try again.
                    </div>
                `;
            }
        }

        window.reviewExamResult = async (resultId) => {
            try {
                const resultDoc = await getDoc(doc(db, "results", resultId));
                if (!resultDoc.exists()) {
                    showMsg("Result not found.");
                    return;
                }
                
                const result = resultDoc.data();
                let reviewHtml = `
                    <h3 style="margin-bottom: 20px; color: var(--primary);">${result.examName || 'Exam'} Review</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--bg); border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <div><strong>Score:</strong> ${result.score || 0}/${result.total || 0}</div>
                                <div><strong>Percentage:</strong> ${result.percentage?.toFixed(1) || 0}%</div>
                            </div>
                            <div>
                                <div><strong>Correct:</strong> ${result.correct || 0}</div>
                                <div><strong>Wrong:</strong> ${result.wrong || 0}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Load questions
                if (result.questions && Array.isArray(result.questions)) {
                    result.questions.forEach((q, index) => {
                        const userAnswer = result.userAnswers?.[index];
                        const correctAnswer = q.correctAnswer;
                        const isCorrect = userAnswer === correctAnswer;
                        
                        reviewHtml += `
                            <div class="review-question ${isCorrect ? 'review-correct' : 'review-wrong'}" style="margin-bottom: 20px;">
                                <div style="font-weight: 600; margin-bottom: 10px;">Q${index + 1}: ${q.question}</div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div style="padding: 10px; border-radius: 8px; background: ${q.optionA === q.correctAnswer ? 'rgba(46, 204, 113, 0.2)' : 'var(--bg)'}">
                                        A) ${q.optionA}
                                        ${userAnswer === 'a' && !isCorrect ? '<span style="color: var(--danger); margin-left: 10px;"> Your Answer</span>' : ''}
                                    </div>
                                    <div style="padding: 10px; border-radius: 8px; background: ${q.optionB === q.correctAnswer ? 'rgba(46, 204, 113, 0.2)' : 'var(--bg)'}">
                                        B) ${q.optionB}
                                        ${userAnswer === 'b' && !isCorrect ? '<span style="color: var(--danger); margin-left: 10px;"> Your Answer</span>' : ''}
                                    </div>
                                    <div style="padding: 10px; border-radius: 8px; background: ${q.optionC === q.correctAnswer ? 'rgba(46, 204, 113, 0.2)' : 'var(--bg)'}">
                                        C) ${q.optionC}
                                        ${userAnswer === 'c' && !isCorrect ? '<span style="color: var(--danger); margin-left: 10px;"> Your Answer</span>' : ''}
                                    </div>
                                    <div style="padding: 10px; border-radius: 8px; background: ${q.optionD === q.correctAnswer ? 'rgba(46, 204, 113, 0.2)' : 'var(--bg)'}">
                                        D) ${q.optionD}
                                        ${userAnswer === 'd' && !isCorrect ? '<span style="color: var(--danger); margin-left: 10px;"> Your Answer</span>' : ''}
                                    </div>
                                </div>
                                
                                <div style="margin-top: 10px; padding: 10px; background: ${isCorrect ? 'rgba(46, 204, 113, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; border-radius: 8px;">
                                    <div><strong>Your Answer:</strong> ${userAnswer ? userAnswer.toUpperCase() : 'Not answered'}</div>
                                    <div><strong>Correct Answer:</strong> ${correctAnswer.toUpperCase()}</div>
                                    ${q.explanation ? `<div style="margin-top: 5px;"><strong>Explanation:</strong> ${q.explanation}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    reviewHtml += '<p>No question details available for this exam.</p>';
                }
                
                openModal("Exam Review", reviewHtml);
                
            } catch(error) {
                console.error("Error reviewing exam:", error);
                showMsg("Error loading exam review.", 'error');
            }
        }

        // --- PROFILE PAGE FUNCTIONS ---
        window.renderProfile = () => {
            updateNav(4);
            
            document.getElementById('main-content').innerHTML = `
                <div class="profile-header-card">
                    <div class="profile-avatar-container" onclick="showProfileUploadModal()">
                        <img id="profile-avatar-img" 
                             src="${currentUser.avatar || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" 
                             alt="Profile" 
                             class="profile-avatar">
                    </div>
                    
                    <h2 style="text-align: center; margin-bottom: 5px;">${currentUser.name}</h2>
                    <p style="text-align: center; opacity: 0.9; margin-bottom: 10px;">
                        <i class="fas fa-user-graduate"></i> ${currentUser.education || 'Student'}
                    </p>
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-value" id="total-exams">0</span>
                            <span class="stat-label">Exams</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="avg-score">0</span>
                            <span class="stat-label">Avg Score</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="study-days">0</span>
                            <span class="stat-label">Study Days</span>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-bottom: 15px;">
                    <h4 style="margin-bottom: 15px; color: var(--text);">
                        <i class="fas fa-user-circle" style="color: var(--primary); margin-right: 10px;"></i>
                        Profile Information
                    </h4>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; color: var(--text-sec); font-size: 0.9rem; margin-bottom: 5px;">Name</label>
                        <input type="text" id="edit-name" value="${currentUser.name}" style="margin-bottom: 15px;">
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; color: var(--text-sec); font-size: 0.9rem; margin-bottom: 5px;">Education</label>
                        <input type="text" id="edit-edu" value="${currentUser.education || ''}" style="margin-bottom: 15px;">
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; color: var(--text-sec); font-size: 0.9rem; margin-bottom: 5px;">Email</label>
                        <input type="email" value="${currentUser.email}" readonly style="background: var(--bg); margin-bottom: 15px;">
                    </div>
                    
                    <button onclick="updateProfile()" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Profile
                    </button>
                </div>
                
                <div class="card" style="margin-bottom: 15px;">
                    <h4 style="margin-bottom: 15px; color: var(--text);">
                        <i class="fas fa-cog" style="color: var(--primary); margin-right: 10px;"></i>
                        Settings
                    </h4>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-weight: 500;">Dark Mode</div>
                            <div style="font-size: 0.8rem; color: var(--text-sec);">Switch between light and dark theme</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="dark-mode-toggle" ${localStorage.getItem('theme') === 'dark' ? 'checked' : ''} onchange="toggleTheme()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-weight: 500;">Notifications</div>
                            <div style="font-size: 0.8rem; color: var(--text-sec);">Receive push notifications</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="notification-toggle" checked onchange="toggleNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <button onclick="showShareOptions()" class="btn btn-sec" style="margin-bottom: 10px;">
                        <i class="fas fa-share-alt"></i> Share App
                    </button>
                    
                    <button onclick="showAbout()" class="btn btn-sec" style="margin-bottom: 10px;">
                        <i class="fas fa-info-circle"></i> About
                    </button>
                    
                    <button onclick="handleLogout()" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
                
                <div id="support-section-container">
                    <!-- Support section will be loaded here -->
                </div>
            `;
            
            loadProfileStats();
            loadSupportSection();
        }

        async function loadProfileStats() {
            try {
                // Get exam stats
                const resultsSnap = await getDocs(
                    query(collection(db, "results"), where("userId", "==", currentUser.uid))
                );
                
                let totalScore = 0;
                let examCount = 0;
                
                resultsSnap.forEach(doc => {
                    const result = doc.data();
                    totalScore += result.percentage || 0;
                    examCount++;
                });
                
                const avgScore = examCount > 0 ? (totalScore / examCount).toFixed(1) : 0;
                
                // Get study days
                const studySnap = await getDoc(doc(db, "Userstudy", currentUser.uid));
                let studyDays = 0;
                if (studySnap.exists()) {
                    const studyData = studySnap.data();
                    studyDays = studyData.completedTopics?.length || 0;
                }
                
                // Update UI
                document.getElementById('total-exams').textContent = examCount;
                document.getElementById('avg-score').textContent = avgScore;
                document.getElementById('study-days').textContent = studyDays;
                
            } catch(error) {
                console.error("Error loading profile stats:", error);
            }
        }

        async function loadSupportSection() {
            await loadSupportLinks();
            const supportHtml = renderSupportSection();
            if (supportHtml) {
                document.getElementById('support-section-container').innerHTML = supportHtml;
            }
        }

        window.updateProfile = async () => {
            const name = document.getElementById('edit-name').value.trim();
            const education = document.getElementById('edit-edu').value.trim();
            
            if (!name) {
                showMsg("Please enter your name.");
                return;
            }
            
            try {
                toggleLoader(true);
                
                await updateDoc(doc(db, "users", currentUser.uid), {
                    name: name,
                    education: education,
                    updatedAt: new Date().toISOString()
                });
                
                currentUser.name = name;
                currentUser.education = education;
                
                showMsg("Profile updated successfully!");
                
            } catch(error) {
                console.error("Error updating profile:", error);
                showMsg("Error updating profile: " + error.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        window.showAbout = () => {
            openModal("About ExamPro", `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <h2 style="margin-bottom: 10px; color: var(--text);">ExamPro</h2>
                    <p style="color: var(--text-sec);">Version 2.0.0</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p style="color: var(--text); line-height: 1.6;">
                        ExamPro is a comprehensive exam preparation platform designed to help students 
                        excel in their academic and competitive exams through smart study plans, 
                        practice quizzes, and detailed analytics.
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--text);">
                        <i class="fas fa-star" style="color: var(--warning); margin-right: 10px;"></i>
                        Features
                    </h4>
                    <ul style="color: var(--text); padding-left: 20px; line-height: 1.6;">
                        <li>Smart Study Plan with progress tracking</li>
                        <li>Memorizing cards for vocabulary and concepts</li>
                        <li>Practice quizzes with instant feedback</li>
                        <li>Leaderboards and rank tracking</li>
                        <li>Detailed exam review and analytics</li>
                        <li>Dark/Light theme support</li>
                    </ul>
                </div>
                
                <div style="padding: 15px; background: var(--bg); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 5px; color: var(--text);">Contact Us</div>
                    <div style="color: var(--text-sec); font-size: 0.9rem;">
                        For support and queries, please use the support section in your profile.
                    </div>
                </div>
            `);
        }

        // --- AUTH FUNCTIONS ---
        window.toggleAuth = (form) => {
            if(form === 'signup') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('signup-form').style.display = 'block';
            } else {
                document.getElementById('signup-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            }
        }

        window.handleLogin = async () => {
            const email = document.getElementById('l-email').value.trim();
            const password = document.getElementById('l-pass').value.trim();
            
            if(!email || !password) {
                showMsg('Please fill in all fields.');
                return;
            }
            
            try {
                toggleLoader(true);
                const userCred = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(db, "users", userCred.user.uid));
                
                if(userDoc.exists()) {
                    currentUser = { ...userCred.user, ...userDoc.data() };
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showMsg(`Welcome back, ${currentUser.name}!`, 'success');
                    
                    setTimeout(() => {
                        document.getElementById('auth-screen').classList.remove('active-screen');
                        document.getElementById('app-screen').classList.add('active-screen');
                        renderHome();
                    }, 500);
                } else {
                    showMsg('User data not found. Please contact support.', 'error');
                }
            } catch(e) {
                showMsg(e.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        window.handleSignup = async () => {
            const name = document.getElementById('s-name').value.trim();
            const gender = document.getElementById('s-gender').value;
            const education = document.getElementById('s-edu').value.trim();
            const email = document.getElementById('s-email').value.trim();
            const password = document.getElementById('s-pass').value.trim();
            
            if(!name || !gender || !education || !email || !password) {
                showMsg('Please fill in all fields.');
                return;
            }
            
            if(password.length < 6) {
                showMsg('Password must be at least 6 characters.');
                return;
            }
            
            try {
                toggleLoader(true);
                const userCred = await createUserWithEmailAndPassword(auth, email, password);
                
                // Select avatar based on gender
                const avatarList = gender === 'Female' ? AVATAR_FEMALE : AVATAR_MALE;
                const randomAvatar = avatarList[Math.floor(Math.random() * avatarList.length)];
                
                // Create user document
                const userData = {
                    uid: userCred.user.uid,
                    name: name,
                    email: email,
                    gender: gender,
                    education: education,
                    avatar: randomAvatar,
                    level: 1,
                    points: 0,
                    totalExams: 0,
                    avgScore: 0,
                    streak: 0,
                    lastLogin: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };
                
                await setDoc(doc(db, "users", userCred.user.uid), userData);
                currentUser = { ...userCred.user, ...userData };
                localStorage.setItem('user', JSON.stringify(currentUser));
                
                // Send welcome notification
                await sendNotification(userCred.user.uid, 'Welcome to ExamPro!', `Hello ${name}, welcome to ExamPro! Start your learning journey now.`, 'broadcast');
                
                showMsg('Account created successfully! Welcome to ExamPro.', 'success');
                
                setTimeout(() => {
                    document.getElementById('auth-screen').classList.remove('active-screen');
                    document.getElementById('app-screen').classList.add('active-screen');
                    renderHome();
                }, 1000);
                
            } catch(e) {
                showMsg(e.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        window.handleLogout = async () => {
            if(await customConfirm("Are you sure you want to logout?")) {
                try {
                    await signOut(auth);
                    localStorage.removeItem('user');
                    currentUser = null;
                    
                    document.getElementById('app-screen').classList.remove('active-screen');
                    document.getElementById('auth-screen').classList.add('active-screen');
                    
                    // Reset forms
                    document.getElementById('login-form').style.display = 'block';
                    document.getElementById('signup-form').style.display = 'none';
                    document.getElementById('l-email').value = '';
                    document.getElementById('l-pass').value = '';
                    
                } catch(e) {
                    showMsg(e.message, 'error');
                }
            }
        }

        // --- HOME PAGE FUNCTIONS ---
        window.renderHome = async () => {
            updateNav(0);
            
            await loadHomeSlides();
            await loadAllCategories();
            
            document.getElementById('main-content').innerHTML = `
                ${renderHomeSlider()}
                
                <div class="news-slider" id="news-slider" style="display: none;">
                    <div class="news-track" id="news-track"></div>
                </div>
                
                <div class="dash-grid">
                    <div class="dash-btn" onclick="openExams()">
                        <div style="font-size: 1.8rem; margin-bottom: 5px; color: var(--primary);">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div style="font-weight: 600;">Exams</div>
                        <div style="font-size: 0.8rem; color: var(--text-sec);">Take tests</div>
                    </div>
                    
                    <div class="dash-btn" onclick="renderStudy()">
                        <div style="font-size: 1.8rem; margin-bottom: 5px; color: var(--success);">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div style="font-weight: 600;">Study</div>
                        <div style="font-size: 0.8rem; color: var(--text-sec);">Smart plan</div>
                    </div>
                    
                    <div class="dash-btn" onclick="renderRank()">
                        <div style="font-size: 1.8rem; margin-bottom: 5px; color: var(--warning);">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div style="font-weight: 600;">Rank</div>
                        <div style="font-size: 0.8rem; color: var(--text-sec);">Leaderboard</div>
                    </div>
                </div>
                
                <div class="card">
                    <h4 style="margin-bottom: 15px; color: var(--text); display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fas fa-fire" style="color: var(--danger); margin-right: 10px;"></i> Live Exams</span>
                        <button onclick="refreshLiveExams()" style="background: none; border: none; color: var(--primary); cursor: pointer;">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </h4>
                    <div id="live-exams-container">
                        Loading live exams...
                    </div>
                </div>
                
                <div class="card">
                    <h4 style="margin-bottom: 15px; color: var(--text);">
                        <i class="fas fa-layer-group" style="color: var(--primary); margin-right: 10px;"></i>
                        Exam Categories
                    </h4>
                    <div id="categories-container">
                        Loading categories...
                    </div>
                </div>
            `;
            
            startSlider();
            loadLiveExams();
            loadCategories();
            loadNewsSlider();
        }

        async function loadLiveExams() {
            try {
                const now = new Date();
                const q = query(
                    collection(db, "exams"),
                    where("status", "==", "live"),
                    where("endTime", ">", now)
                );
                const snap = await getDocs(q);
                
                const container = document.getElementById('live-exams-container');
                
                if(snap.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-sec);">
                            <i class="fas fa-clock" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>No live exams at the moment</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                snap.forEach(doc => {
                    const exam = { id: doc.id, ...doc.data() };
                    const endTime = exam.endTime?.toDate ? exam.endTime.toDate() : new Date(exam.endTime);
                    const timeLeft = Math.max(0, endTime - now);
                    const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                    
                    html += `
                        <div class="mini-card" onclick="takeExam('${exam.id}')" style="position: relative;">
                            <div class="live-badge">
                                <i class="fas fa-circle"></i> LIVE
                            </div>
                            
                            <img src="${exam.thumbnail || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" 
                                 alt="${exam.name}">
                            
                            <h4>${exam.name}</h4>
                            <small style="color: var(--text-sec);">
                                ${exam.questionsCount || 20} Questions  ${hoursLeft}H left
                            </small>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch(error) {
                console.error("Error loading live exams:", error);
                document.getElementById('live-exams-container').innerHTML = `
                    <div style="text-align: center; padding: 10px; color: var(--danger);">
                        Error loading live exams
                    </div>
                `;
            }
        }

        async function loadCategories() {
            try {
                const container = document.getElementById('categories-container');
                
                if(allCategories.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-sec);">
                            <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>No categories available</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="grid-container">';
                
                allCategories.forEach(category => {
                    html += `
                        <div class="mini-card" onclick="openCategoryExams('${category}')">
                            <div style="font-size: 2rem; margin-bottom: 10px; color: var(--primary);">
                                <i class="fas fa-folder"></i>
                            </div>
                            <h4>${category}</h4>
                            <small style="color: var(--text-sec);">Exams</small>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch(error) {
                console.error("Error loading categories:", error);
                document.getElementById('categories-container').innerHTML = `
                    <div style="text-align: center; padding: 10px; color: var(--danger);">
                        Error loading categories
                    </div>
                `;
            }
        }

        async function loadNewsSlider() {
            try {
                const q = query(collection(db, "notifications"), where("type", "==", "broadcast"));
                const snap = await getDocs(q);
                
                const newsSlider = document.getElementById('news-slider');
                const newsTrack = document.getElementById('news-track');
                
                if(snap.empty) {
                    newsSlider.style.display = 'none';
                    return;
                }
                
                let newsItems = [];
                snap.forEach(doc => {
                    const notif = doc.data();
                    if(!notif.read) {
                        newsItems.push(notif);
                    }
                });
                
                if(newsItems.length === 0) {
                    newsSlider.style.display = 'none';
                    return;
                }
                
                newsSlider.style.display = 'block';
                
                let html = '';
                newsItems.forEach(item => {
                    html += `
                        <div class="news-item ${item.read ? '' : 'new-notification'}" onclick="toggleNotificationPopup()">
                            <i class="fas fa-bullhorn"></i>
                            ${item.title}
                        </div>
                    `;
                });
                
                // Duplicate items for seamless animation
                newsTrack.innerHTML = html + html;
                
            } catch(error) {
                console.error("Error loading news slider:", error);
            }
        }

        window.openExams = () => {
            openModal("Available Exams", `
                <div class="category-filter">
                    <div class="exam-select-wrapper">
                        <select id="exam-category-select" class="category-select" onchange="loadExamsByCategory()">
                            <option value="all">All Categories</option>
                            ${allCategories.map(cat => 
                                `<option value="${cat}">${cat}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <div id="exams-list" style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
                    Loading exams...
                </div>
            `);
            
            loadExamsByCategory();
        }

        async function loadExamsByCategory() {
            try {
                const category = document.getElementById('exam-category-select').value;
                const container = document.getElementById('exams-list');
                container.innerHTML = '<div class="shimmer" style="height: 100px; border-radius: 15px;"></div>';
                
                let q;
                if(category === 'all') {
                    q = query(collection(db, "exams"), orderBy("createdAt", "desc"));
                } else {
                    q = query(collection(db, "exams"), where("category", "==", category), orderBy("createdAt", "desc"));
                }
                
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-sec);">
                            <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>No exams found in this category</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                snap.forEach(doc => {
                    const exam = { id: doc.id, ...doc.data() };
                    const isLive = exam.status === 'live';
                    const now = new Date();
                    const endTime = exam.endTime?.toDate ? exam.endTime.toDate() : new Date(exam.endTime);
                    const isExpired = endTime < now;
                    
                    html += `
                        <div class="card" style="margin-bottom: 10px; ${isLive ? 'border-left: 4px solid var(--danger);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-weight: 600;">${exam.name}</div>
                                ${isLive ? '<span class="live-badge" style="position: static; font-size: 0.7rem;">LIVE</span>' : ''}
                            </div>
                            
                            <div style="color: var(--text-sec); font-size: 0.9rem; margin-bottom: 10px;">
                                ${exam.questionsCount || 20} Questions  ${exam.duration || 30} Minutes
                                ${exam.category ? ` ${exam.category}` : ''}
                            </div>
                            
                            <button onclick="takeExam('${exam.id}')" 
                                    class="btn ${isLive ? 'btn-danger' : isExpired ? 'btn-sec' : 'btn-primary'}" 
                                    ${isExpired ? 'disabled' : ''}
                                    style="font-size: 0.9rem; padding: 10px;">
                                ${isExpired ? 'Expired' : isLive ? 'Take Live Exam' : 'Start Exam'}
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch(error) {
                console.error("Error loading exams:", error);
                document.getElementById('exams-list').innerHTML = `
                    <div style="text-align: center; padding: 10px; color: var(--danger);">
                        Error loading exams
                    </div>
                `;
            }
        }

        window.openCategoryExams = (category) => {
            selectedCategory = category;
            localStorage.setItem('selectedCategory', category);
            openExams();
            
            // Set the category in the dropdown
            setTimeout(() => {
                const select = document.getElementById('exam-category-select');
                if(select) {
                    select.value = category;
                    loadExamsByCategory();
                }
            }, 100);
        }

        window.takeExam = async (examId) => {
            try {
                toggleLoader(true);
                
                const examDoc = await getDoc(doc(db, "exams", examId));
                if(!examDoc.exists()) {
                    showMsg("Exam not found.", 'error');
                    return;
                }
                
                const exam = { id: examDoc.id, ...examDoc.data() };
                
                // Check if exam is expired
                const now = new Date();
                const endTime = exam.endTime?.toDate ? exam.endTime.toDate() : new Date(exam.endTime);
                if(endTime < now && exam.status !== 'live') {
                    showMsg("This exam has expired.", 'error');
                    return;
                }
                
                // Check if user already took this exam
                const resultQuery = query(
                    collection(db, "results"),
                    where("userId", "==", currentUser.uid),
                    where("examId", "==", examId)
                );
                const resultSnap = await getDocs(resultQuery);
                
                if(!resultSnap.empty && !exam.allowRetake) {
                    showMsg("You have already taken this exam. Retake is not allowed.", 'error');
                    return;
                }
                
                // Load questions
                const questionsQuery = query(
                    collection(db, "questions"),
                    where("examId", "==", examId)
                );
                const questionsSnap = await getDocs(questionsQuery);
                
                if(questionsSnap.empty) {
                    showMsg("No questions found for this exam.", 'error');
                    return;
                }
                
                let questions = [];
                questionsSnap.forEach(doc => {
                    questions.push({ id: doc.id, ...doc.data() });
                });
                
                // Shuffle questions and options if required
                if(exam.shuffleQuestions) {
                    questions = questions.sort(() => Math.random() - 0.5);
                }
                
                if(exam.shuffleOptions) {
                    questions.forEach(q => {
                        const options = [
                            { letter: 'a', text: q.optionA },
                            { letter: 'b', text: q.optionB },
                            { letter: 'c', text: q.optionC },
                            { letter: 'd', text: q.optionD }
                        ].sort(() => Math.random() - 0.5);
                        
                        q.optionA = options[0].text;
                        q.optionB = options[1].text;
                        q.optionC = options[2].text;
                        q.optionD = options[3].text;
                        // Note: We need to track the original correct answer
                        q.originalCorrect = q.correctAnswer;
                        q.correctAnswer = options.find(opt => opt.letter === q.originalCorrect)?.letter || q.correctAnswer;
                    });
                }
                
                // Limit questions if needed
                if(exam.questionsCount && questions.length > exam.questionsCount) {
                    questions = questions.slice(0, exam.questionsCount);
                }
                
                // Start exam
                startExam(exam, questions);
                
            } catch(error) {
                console.error("Error taking exam:", error);
                showMsg("Error starting exam: " + error.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        let currentExam = null;
        let examQuestions = [];
        let examAnswers = {};
        let examStartTime = null;
        let examTimerInterval = null;

        function startExam(exam, questions) {
            currentExam = exam;
            examQuestions = questions;
            examAnswers = {};
            examStartTime = new Date();
            
            // Close any open modal
            closeModal();
            
            // Show exam screen
            document.getElementById('main-content').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="color: var(--text);">${exam.name}</h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="exam-timer" style="background: var(--gradient-danger); color: white; padding: 8px 15px; border-radius: 20px; font-weight: 600;">
                                ${exam.duration || 30}:00
                            </div>
                            <button onclick="submitExam()" class="btn btn-success" style="padding: 8px 15px; font-size: 0.9rem;">
                                <i class="fas fa-paper-plane"></i> Submit
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border);">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div>
                                <div style="font-size: 0.9rem; color: var(--text-sec);">Questions</div>
                                <div style="font-weight: 600;">${questions.length}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: var(--text-sec);">Time</div>
                                <div style="font-weight: 600;">${exam.duration || 30} min</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: var(--text-sec);">Category</div>
                                <div style="font-weight: 600;">${exam.category || 'General'}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="exam-questions-container" style="margin-bottom: 30px;"></div>
                
                <div style="position: fixed; bottom: 90px; left: 0; right: 0; background: var(--card-bg); padding: 15px 20px; border-top: 1px solid var(--border); box-shadow: 0 -5px 20px rgba(0,0,0,0.05);">
                    <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;">
                        ${questions.map((_, index) => `
                            <button onclick="scrollToQuestion(${index})" 
                                    class="question-nav-btn ${examAnswers[questions[index].id] ? 'answered' : 'unanswered'}"
                                    style="min-width: 40px; height: 40px; border-radius: 10px; border: 2px solid ${examAnswers[questions[index].id] ? 'var(--success)' : 'var(--border)'}; background: ${examAnswers[questions[index].id] ? 'rgba(46, 204, 113, 0.1)' : 'var(--card-bg)'}; color: var(--text); font-weight: 600; cursor: pointer;">
                                ${index + 1}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            renderExamQuestions();
            startExamTimer(exam.duration || 30);
        }

        function renderExamQuestions() {
            const container = document.getElementById('exam-questions-container');
            let html = '';
            
            examQuestions.forEach((question, index) => {
                html += `
                    <div class="mcq-anim card" id="question-${index}" style="animation-delay: ${index * 0.1}s; margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <span style="background: var(--primary); color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; margin-right: 10px;">Question ${index + 1}</span>
                            <span style="font-weight: 600;">${question.question}</span>
                        </div>
                        
                        <div class="mcq-option ${examAnswers[question.id] === 'a' ? 'selected' : ''}" onclick="selectExamAnswer('${question.id}', 'a')">
                            <div class="mcq-circle"></div>
                            <span>A) ${question.optionA}</span>
                        </div>
                        <div class="mcq-option ${examAnswers[question.id] === 'b' ? 'selected' : ''}" onclick="selectExamAnswer('${question.id}', 'b')">
                            <div class="mcq-circle"></div>
                            <span>B) ${question.optionB}</span>
                        </div>
                        <div class="mcq-option ${examAnswers[question.id] === 'c' ? 'selected' : ''}" onclick="selectExamAnswer('${question.id}', 'c')">
                            <div class="mcq-circle"></div>
                            <span>C) ${question.optionC}</span>
                        </div>
                        <div class="mcq-option ${examAnswers[question.id] === 'd' ? 'selected' : ''}" onclick="selectExamAnswer('${question.id}', 'd')">
                            <div class="mcq-circle"></div>
                            <span>D) ${question.optionD}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        window.selectExamAnswer = (questionId, answer) => {
            examAnswers[questionId] = answer;
            
            // Update UI
            const questionIndex = examQuestions.findIndex(q => q.id === questionId);
            const questionContainer = document.getElementById(`question-${questionIndex}`);
            
            if(questionContainer) {
                // Remove selected from all options
                questionContainer.querySelectorAll('.mcq-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected to chosen option
                const optionDivs = questionContainer.querySelectorAll('.mcq-option');
                const optionIndex = ['a', 'b', 'c', 'd'].indexOf(answer);
                if(optionDivs[optionIndex]) {
                    optionDivs[optionIndex].classList.add('selected');
                }
            }
            
            // Update navigation buttons
            updateQuestionNav();
        }

        function updateQuestionNav() {
            examQuestions.forEach((question, index) => {
                const btn = document.querySelector(`.question-nav-btn:nth-child(${index + 1})`);
                if(btn) {
                    if(examAnswers[question.id]) {
                        btn.classList.add('answered');
                        btn.classList.remove('unanswered');
                        btn.style.borderColor = 'var(--success)';
                        btn.style.background = 'rgba(46, 204, 113, 0.1)';
                    } else {
                        btn.classList.add('unanswered');
                        btn.classList.remove('answered');
                        btn.style.borderColor = 'var(--border)';
                        btn.style.background = 'var(--card-bg)';
                    }
                }
            });
        }

        window.scrollToQuestion = (index) => {
            const element = document.getElementById(`question-${index}`);
            if(element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function startExamTimer(minutes) {
            let timeLeft = minutes * 60;
            
            if(examTimerInterval) clearInterval(examTimerInterval);
            
            examTimerInterval = setInterval(() => {
                timeLeft--;
                
                const minutesLeft = Math.floor(timeLeft / 60);
                const secondsLeft = timeLeft % 60;
                
                document.getElementById('exam-timer').textContent = 
                    `${minutesLeft.toString().padStart(2, '0')}:${secondsLeft.toString().padStart(2, '0')}`;
                
                if(timeLeft <= 0) {
                    clearInterval(examTimerInterval);
                    submitExam();
                }
            }, 1000);
        }

        window.submitExam = async () => {
            if(examTimerInterval) {
                clearInterval(examTimerInterval);
            }
            
            // Calculate score
            let correct = 0;
            let wrong = 0;
            let skipped = 0;
            const total = examQuestions.length;
            
            examQuestions.forEach(question => {
                const userAnswer = examAnswers[question.id];
                if(!userAnswer) {
                    skipped++;
                } else if(userAnswer === question.correctAnswer) {
                    correct++;
                } else {
                    wrong++;
                }
            });
            
            const score = correct;
            const percentage = total > 0 ? (correct / total) * 100 : 0;
            const timeTaken = Math.floor((new Date() - examStartTime) / 1000); // in seconds
            
            // Save result
            try {
                const resultData = {
                    userId: currentUser.uid,
                    examId: currentExam.id,
                    examName: currentExam.name,
                    category: currentExam.category,
                    score: score,
                    total: total,
                    correct: correct,
                    wrong: wrong,
                    skipped: skipped,
                    percentage: percentage,
                    timeTaken: timeTaken,
                    userAnswers: examAnswers,
                    questions: examQuestions,
                    timestamp: new Date().toISOString()
                };
                
                await addDoc(collection(db, "results"), resultData);
                
                // Update user stats
                const userRef = doc(db, "users", currentUser.uid);
                const userSnap = await getDoc(userRef);
                if(userSnap.exists()) {
                    const userData = userSnap.data();
                    const newTotalExams = (userData.totalExams || 0) + 1;
                    const newAvgScore = ((userData.avgScore || 0) * (newTotalExams - 1) + percentage) / newTotalExams;
                    
                    await updateDoc(userRef, {
                        totalExams: newTotalExams,
                        avgScore: newAvgScore,
                        points: (userData.points || 0) + Math.floor(percentage / 10)
                    });
                }
                
                // Show result
                showExamResult(correct, wrong, skipped, total, percentage, timeTaken);
                
            } catch(error) {
                console.error("Error saving exam result:", error);
                showMsg("Error saving result: " + error.message, 'error');
            }
        }

        function showExamResult(correct, wrong, skipped, total, percentage, timeTaken) {
            const minutesTaken = Math.floor(timeTaken / 60);
            const secondsTaken = timeTaken % 60;
            
            openModal("Exam Result", `
                <div class="result-breakdown">
                    <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary);">
                        ${currentExam.name}
                    </h3>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3rem; font-weight: 700; color: ${percentage >= 70 ? 'var(--success)' : percentage >= 50 ? 'var(--warning)' : 'var(--danger)'};">
                            ${percentage.toFixed(1)}%
                        </div>
                        <div style="color: var(--text-sec);">Your Score</div>
                    </div>
                    
                    <div class="breakdown-grid">
                        <div class="breakdown-item breakdown-correct">
                            <span class="breakdown-value">${correct}</span>
                            <span class="breakdown-label">Correct</span>
                        </div>
                        <div class="breakdown-item breakdown-wrong">
                            <span class="breakdown-value">${wrong}</span>
                            <span class="breakdown-label">Wrong</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-value">${skipped}</span>
                            <span class="breakdown-label">Skipped</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Time Taken:</span>
                            <span>${minutesTaken}m ${secondsTaken}s</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total Questions:</span>
                            <span>${total}</span>
                        </div>
                    </div>
                    
                    ${percentage >= 70 ? `
                        <div class="points-change positive" style="margin-top: 15px;">
                            <i class="fas fa-star"></i> Excellent! You passed with flying colors!
                        </div>
                    ` : percentage >= 50 ? `
                        <div class="points-change" style="margin-top: 15px; background: rgba(243, 156, 18, 0.1); color: var(--warning);">
                            <i class="fas fa-check"></i> Good attempt! Keep practicing to improve.
                        </div>
                    ` : `
                        <div class="points-change negative" style="margin-top: 15px;">
                            <i class="fas fa-redo"></i> Need more practice. Review the questions and try again.
                        </div>
                    `}
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="reviewExam()" class="btn btn-primary" style="margin-bottom: 10px;">
                        <i class="fas fa-eye"></i> Review Answers
                    </button>
                    <button onclick="closeExamAndReturn()" class="btn btn-sec">
                        <i class="fas fa-home"></i> Back to Home
                    </button>
                </div>
            `);
        }

        window.reviewExam = () => {
            closeModal();
            // Show review of exam questions
            let reviewHtml = `
                <h3 style="margin-bottom: 20px; color: var(--primary);">${currentExam.name} - Review</h3>
            `;
            
            examQuestions.forEach((question, index) => {
                const userAnswer = examAnswers[question.id];
                const isCorrect = userAnswer === question.correctAnswer;
                
                reviewHtml += `
                    <div class="review-question ${isCorrect ? 'review-correct' : 'review-wrong'}" style="margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 10px;">Q${index + 1}: ${question.question}</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="padding: 10px; border-radius: 8px; background: ${question.optionA === question.correctAnswer ? 'rgba(46, 204, 113, 0.2)' : 'var(--bg)'}">
                                A) ${question.optionA}
                                ${userAnswer === 'a' && !isCorrect ? '<span style="color: var(--danger); margin-left: 10px;"> Your Answer</span>' : ''}
                            </div>
                            <div style="padding: 10px; border-radius: 8px; background: ${question.optionB === question.correctAnswer ? 'rgba(46, 204, 113, 0.2)' : 'var(--bg)'}">
                                B) ${question.optionB}
                                ${userAnswer === 'b' && !isCorrect ? '<span style="color: var(--danger); margin-left: 10px;"> Your Answer</span>' : ''}
                            </div>
                            <div style="padding: 10px; border-radius: 8px; background: ${question.optionC === question.correctAnswer ? 'rgba(46, 204, 113, 0.2)' : 'var(--bg)'}">
                                C) ${question.optionC}
                                ${userAnswer === 'c' && !isCorrect ? '<span style="color: var(--danger); margin-left: 10px;"> Your Answer</span>' : ''}
                            </div>
                            <div style="padding: 10px; border-radius: 8px; background: ${question.optionD === question.correctAnswer ? 'rgba(46, 204, 113, 0.2)' : 'var(--bg)'}">
                                D) ${question.optionD}
                                ${userAnswer === 'd' && !isCorrect ? '<span style="color: var(--danger); margin-left: 10px;"> Your Answer</span>' : ''}
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px; padding: 10px; background: ${isCorrect ? 'rgba(46, 204, 113, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; border-radius: 8px;">
                            <div><strong>Your Answer:</strong> ${userAnswer ? userAnswer.toUpperCase() : 'Not answered'}</div>
                            <div><strong>Correct Answer:</strong> ${question.correctAnswer.toUpperCase()}</div>
                            ${question.explanation ? `<div style="margin-top: 5px;"><strong>Explanation:</strong> ${question.explanation}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            openModal("Exam Review", reviewHtml);
        }

        window.closeExamAndReturn = () => {
            closeModal();
            renderHome();
        }

        // --- UTILITY FUNCTIONS ---
        window.toggleLoader = (show) => {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        window.updateNav = (index) => {
            document.querySelectorAll('.nav-item').forEach((item, i) => {
                if(i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        window.openModal = (title, body) => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = body;
            document.getElementById('generic-modal').style.display = 'flex';
        }

        window.closeModal = () => {
            document.getElementById('generic-modal').style.display = 'none';
            document.getElementById('share-modal').style.display = 'none';
            document.getElementById('profile-upload-modal').style.display = 'none';
            document.getElementById('forgot-password-modal').style.display = 'none';
        }

        // --- INITIALIZATION ---
        function initApp() {
            // Check for saved user
            const savedUser = localStorage.getItem('user');
            if(savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('auth-screen').classList.remove('active-screen');
                    document.getElementById('app-screen').classList.add('active-screen');
                    renderHome();
                } catch(e) {
                    localStorage.removeItem('user');
                }
            }
            
            hideSplash();
            
            // Initialize Firebase auth listener
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    try {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if(userDoc.exists()) {
                            currentUser = { ...user, ...userDoc.data() };
                            localStorage.setItem('user', JSON.stringify(currentUser));
                            
                            if(!document.getElementById('app-screen').classList.contains('active-screen')) {
                                document.getElementById('auth-screen').classList.remove('active-screen');
                                document.getElementById('app-screen').classList.add('active-screen');
                                renderHome();
                            }
                            
                            // Load notifications
                            loadNotifications();
                            
                            // Load support links
                            loadSupportLinks();
                        }
                    } catch(error) {
                        console.error("Error loading user data:", error);
                    }
                }
            });
            
            // Load categories
            loadAllCategories();
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
