<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamPro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    
    <style>
        /* SIMPLIFIED CSS - ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ 30% ‡¶ï‡ßã‡¶° ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá */
        :root {
            --primary: #6C63FF;
            --secondary: #8f94fb;
            --bg: #F4F7F6;
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-sec: #636e72;
            --border: #eeeeee;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --radius: 18px;
            --danger: #ff4757;
            --success: #2ecc71;
            --white: #ffffff;
            --gradient-primary: linear-gradient(135deg, #6C63FF 0%, #8f94fb 100%);
        }

        .dark-mode {
            --bg: #1e1e2e;
            --card-bg: #27293d;
            --text: #e0e0e0;
            --text-sec: #a0a0a0;
            --border: #444444;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; }
        body { 
            background: var(--bg); color: var(--text); padding-bottom: 90px; 
            transition: background 0.3s, color 0.3s; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* UTILS */
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.4s ease; }
        .active-screen { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* SPLASH SCREEN */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s ease-out;
        }
        .splash-logo {
            width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: pulseLogo 2s infinite ease-in-out;
            border: 4px solid var(--primary);
        }
        .splash-text {
            margin-top: 20px; font-size: 1.5rem; font-weight: 700; color: var(--primary);
            animation: fadeInUp 1s ease forwards; opacity: 0;
        }
        @keyframes pulseLogo {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 99, 255, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(108, 99, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 99, 255, 0); }
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* NETWORK STATUS */
        #network-status {
            position: fixed; top: 0; left: 0; width: 100%; 
            background: var(--danger); color: white; text-align: center; 
            padding: 12px; z-index: 100000; display: none;
            font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* INPUTS */
        input, select, textarea {
            width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 15px;
            background: var(--card-bg); color: var(--text); font-size: 1rem; margin-bottom: 12px;
            outline: none; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(108, 99, 255, 0.15); }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-weight: 600; cursor: pointer; font-size: 1rem; margin-top: 5px; transition: 0.2s; }
        .btn-primary { background: var(--gradient-primary); color: white; box-shadow: 0 8px 20px rgba(0,0,0, 0.2); }
        .btn-danger { background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%); color: white; }
        .btn-sec { background: var(--border); color: var(--text); }
        .btn-success { background: linear-gradient(135deg, #2ecc71 0%, #1dd1a1 100%); color: white; }
        .btn:active { transform: scale(0.98); }

        /* HEADER */
        header { 
            background: var(--gradient-primary);
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--white) !important; }
        
        /* CARDS */
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        
        /* NAV */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--card-bg); display: flex; justify-content: space-around; 
            padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); 
            z-index: 1000; border-top: 1px solid var(--border); 
        }
        .nav-item { 
            text-align: center; color: #aaa; font-size: 0.7rem; cursor: pointer; 
            flex: 1; display: flex; flex-direction: column; align-items: center;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 3px; display: block; }

        /* MODAL */
        #custom-alert {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg); padding: 25px; width: 90%; max-width: 350px;
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center; z-index: 10000; display: none; transition: 0.3s; border: 1px solid var(--border);
        }
        #custom-alert.show { display: block; animation: popIn 0.3s forwards; }
        @keyframes popIn { to { transform: translate(-50%, -50%) scale(1); } }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; animation: fadeIn 0.3s; }

        /* FIXED POPUP CENTER */
        #confirm-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 110000;
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
        }

        #confirm-modal.active {
            display: flex !important;
        }

        .confirm-box {
            background: var(--card-bg); 
            width: 90%; 
            max-width: 320px; 
            padding: 25px;
            border-radius: 20px; 
            text-align: center; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* GRID CARDS */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 10px; }
        .mini-card {
            background: var(--card-bg); padding: 15px; border-radius: 15px;
            box-shadow: var(--shadow); text-align: center; cursor: pointer;
            border: 1px solid var(--border); transition: 0.2s; position: relative; overflow: hidden;
        }
        .mini-card:active { transform: scale(0.95); }
        
        /* DASHBOARD */
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .dash-btn { background: var(--card-bg); padding: 20px 10px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border: 1px solid var(--border); }
        
        /* ADMIN */
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .admin-item { background: var(--card-bg); padding: 20px; border-radius: 18px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border-bottom: 4px solid var(--primary); }
        
        /* MCQ STYLES */
        .mcq-option {
            display: flex; align-items: center; padding: 15px; margin-top: 10px;
            border: 2px solid var(--border); border-radius: 12px; cursor: pointer;
            transition: all 0.2s; background: var(--card-bg);
        }
        .mcq-option:hover { border-color: var(--primary); background: var(--bg); transform: translateX(5px); }
        .mcq-option.selected { border-color: var(--primary); background: rgba(108, 99, 255, 0.1); font-weight: 600; }
        
        /* PROFILE */
        .profile-header-card {
            background: var(--gradient-primary);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        /* RESPONSIVE */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            .card { padding: 15px; }
            .dash-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .admin-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="network-status">
        <i class="fas fa-wifi-slash"></i> No internet connection.
    </div>

    <div id="splash-screen">
        <img src="13877.jpg" alt="Logo" class="splash-logo">
        <div class="splash-text">ExamPro</div>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <div id="custom-alert">
        <h2 style="color:var(--primary); margin-bottom:10px;">ExamPro</h2>
        <p id="alert-msg" style="color:var(--text-sec); margin-bottom:20px; font-size:1rem;">Message</p>
        <button onclick="closeAlert()" class="btn btn-primary">OK</button>
    </div>

    <div id="confirm-modal">
        <div class="confirm-box">
            <i class="fas fa-exclamation-triangle" style="font-size:3rem; color:var(--danger); margin-bottom:15px;"></i>
            <h3 style="margin-bottom:10px;">Are you sure?</h3>
            <p id="conf-msg" style="color:var(--text-sec); font-size:0.95rem;">This action cannot be undone.</p>
            <div style="display:flex; gap:10px; margin-top:20px; justify-content:center;">
                <button onclick="resolveConfirm(false)" class="btn btn-sec" style="margin-top:0; width:auto; padding:10px 20px;">Cancel</button>
                <button onclick="resolveConfirm(true)" class="btn btn-danger" style="margin-top:0; width:auto; padding:10px 20px;">Yes, Delete</button>
            </div>
        </div>
    </div>

    <section id="auth-screen" class="screen">
        <div style="display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; background:var(--gradient-primary);">
            <div style="width:100%; max-width:450px; background:var(--card-bg); border-radius:20px; padding:40px 30px; box-shadow:var(--shadow); border:1px solid var(--border);">
                <h1 style="text-align:center; color:var(--primary); font-size:2.2rem; margin-bottom:5px;">ExamPro</h1>
                <p style="text-align:center; color:var(--text-sec); margin-bottom:30px; font-size:0.95rem;">Login to continue</p>
                
                <div id="login-form">
                    <input type="email" id="l-email" placeholder="Email Address">
                    <input type="password" id="l-pass" placeholder="Password">
                    <button onclick="handleLogin()" class="btn btn-primary">Log In</button>
                    
                    <p style="margin-top:20px; color:var(--text-sec); text-align:center;">
                        New User? 
                        <b onclick="toggleAuth('signup')" style="color:var(--primary); cursor:pointer; font-weight:600;">Create Account</b>
                    </p>
                </div>

                <div id="signup-form" style="display:none;">
                    <input type="text" id="s-name" placeholder="Full Name">
                    <select id="s-gender">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input type="text" id="s-edu" placeholder="Education (e.g. HSC)">
                    <input type="email" id="s-email" placeholder="Email Address">
                    <input type="password" id="s-pass" placeholder="Password (minimum 6 characters)">
                    <button onclick="handleSignup()" class="btn btn-primary">Create Account</button>
                    
                    <p style="margin-top:20px; color:var(--text-sec); text-align:center;">
                        Already have an account? 
                        <b onclick="toggleAuth('login')" style="color:var(--primary); cursor:pointer; font-weight:600;">Log In</b>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section id="app-screen" class="screen">
        <header>
            <div class="logo">ExamPro</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <i onclick="toggleTheme()" id="theme-icon" class="fas fa-moon" style="font-size:1.4rem; cursor:pointer; color:var(--white);"></i>
            </div>
        </header>

        <div id="main-content" class="container"></div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="renderHome()"><i class="fas fa-home"></i> <span>Home</span></div>
            <div class="nav-item" onclick="renderStudy()"><i class="fas fa-book-open"></i> <span>Study</span></div>
            <div class="nav-item" onclick="renderRank()"><i class="fas fa-trophy"></i> <span>Rank</span></div>
            <div class="nav-item" onclick="renderProfile()"><i class="fas fa-user"></i> <span>Profile</span></div>
            <div class="nav-item" id="admin-nav" style="display:none;" onclick="renderAdmin()"><i class="fas fa-th-large"></i> <span>Admin</span></div>
        </nav>
    </section>

    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom:20px; color:var(--primary);">Title</h2>
            <div id="modal-body"></div>
            <button onclick="closeModal()" class="btn btn-sec" style="margin-top:20px;">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, deleteDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBW0-UiTB83ikUOztrT6ECAkOlnzxykKYQ",
            authDomain: "mcq-exam-b150e.firebaseapp.com",
            projectId: "mcq-exam-b150e",
            storageBucket: "mcq-exam-b150e.firebasestorage.app",
            messagingSenderId: "751727102033",
            appId: "1:751727102033:web:35995f15619e300872d070",
            measurementId: "G-9NS51NRGER"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Variables
        let currentUser = null;
        let timerInterval;
        let selectedCategory = localStorage.getItem('selectedCategory') || '';
        let allCategories = [];

        // AVATARS
        const AVATAR_MALE = [
            "https://cdn-icons-png.flaticon.com/512/4825/4825038.png",
            "https://cdn-icons-png.flaticon.com/512/4333/4333609.png",
            "https://cdn-icons-png.flaticon.com/512/4140/4140047.png"
        ];
        
        const AVATAR_FEMALE = [
            "https://cdn-icons-png.flaticon.com/512/4825/4825112.png",
            "https://cdn-icons-png.flaticon.com/512/6997/6997662.png",
            "https://cdn-icons-png.flaticon.com/512/4140/4140037.png"
        ];

        // Network Status
        function updateNetworkStatus() {
            const networkStatus = document.getElementById('network-status');
            if (!navigator.onLine) {
                networkStatus.style.display = 'block';
            } else {
                networkStatus.style.display = 'none';
            }
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);

        // Splash Screen
        function hideSplash() {
            const splash = document.getElementById('splash-screen');
            if(splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 600);
            }
        }

        // Confirm Modal
        let confirmResolver = null;
        window.customConfirm = (msg) => {
            const m = document.getElementById('confirm-modal');
            document.getElementById('conf-msg').innerText = msg;
            m.classList.add('active'); 
            return new Promise((resolve) => {
                confirmResolver = resolve;
            });
        }
        
        window.resolveConfirm = (val) => {
            const m = document.getElementById('confirm-modal');
            m.classList.remove('active');
            if(confirmResolver) confirmResolver(val);
        }

        // Utils
        window.showMsg = (msg, type = 'info') => {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('custom-alert').classList.add('show');
        }
        
        window.closeAlert = () => document.getElementById('custom-alert').classList.remove('show');
        
        window.toggleTheme = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        // Set initial theme
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').className = 'fas fa-sun';
        }

        // Auth Functions
        window.toggleAuth = (m) => {
            document.getElementById('login-form').style.display = m==='login'?'block':'none';
            document.getElementById('signup-form').style.display = m==='signup'?'block':'none';
        }
        
        window.handleLogin = async () => {
            const email = document.getElementById('l-email').value;
            const password = document.getElementById('l-pass').value;
            
            if(!email || !password) {
                return showMsg("Please enter both email and password", 'error');
            }
            
            try { 
                toggleLoader(true); 
                await signInWithEmailAndPassword(auth, email, password); 
            } 
            catch(e) { 
                showMsg("Your email or password is wrong", 'error');
                toggleLoader(false); 
            }
        }
        
        window.handleSignup = async () => {
            const n=document.getElementById('s-name').value, 
                  g=document.getElementById('s-gender').value, 
                  e=document.getElementById('s-edu').value,
                  em=document.getElementById('s-email').value,
                  p=document.getElementById('s-pass').value;
            
            if(!n || !g || !em || !p) return showMsg("Please fill all required details", 'error');
            if(p.length < 6) return showMsg("Password must be at least 6 characters", 'error');
            
            try {
                toggleLoader(true);
                const res = await createUserWithEmailAndPassword(auth, em, p);
                
                const defaultAvatar = g === 'Female' ? AVATAR_FEMALE[0] : AVATAR_MALE[0];
                
                await setDoc(doc(db, "users", res.user.uid), {
                    name: n, gender: g, education: e, email: res.user.email, role: 'student', 
                    points: 0, level: 1, joined: new Date().toLocaleDateString(), isBanned: false,
                    examsTaken: [], avatar: defaultAvatar
                });
                showMsg("Account Created Successfully!");
                toggleAuth('login');
            } catch(e) { 
                showMsg(e.message, 'error');
                toggleLoader(false); 
            }
        }
        
        window.handleLogout = () => signOut(auth).then(()=>location.reload());

        // Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    currentUser = { uid: user.uid, ...snap.data() };
                    
                    if(currentUser.isBanned) {
                        await signOut(auth);
                        showMsg("You are BANNED by Admin.");
                        toggleLoader(false);
                        hideSplash();
                        return;
                    }

                    document.getElementById('auth-screen').classList.remove('active-screen');
                    document.getElementById('app-screen').classList.add('active-screen');
                    if(currentUser.role === 'admin') document.getElementById('admin-nav').style.display = 'block';
                    
                    renderHome();
                } else {
                    await signOut(auth);
                }
            } else {
                document.getElementById('app-screen').classList.remove('active-screen');
                document.getElementById('auth-screen').classList.add('active-screen');
            }
            toggleLoader(false);
            setTimeout(hideSplash, 500); 
        });

        // Load Categories
        async function loadAllCategories() {
            try {
                const categoriesSet = new Set();
                const examsSnap = await getDocs(collection(db, "exams"));
                examsSnap.forEach(doc => {
                    const data = doc.data();
                    if(data.category) {
                        categoriesSet.add(data.category);
                    }
                });
                
                allCategories = Array.from(categoriesSet).sort();
                return allCategories;
            } catch(error) {
                console.error("Error loading categories:", error);
                return [];
            }
        }

        // HOME PAGE
        window.renderHome = async () => {
            updateNav(0);
            await loadAllCategories();
            
            document.getElementById('main-content').innerHTML = `
                <div class="card" style="background:var(--gradient-primary); color:white; border:none; padding:25px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h2>Hi, ${currentUser.name.split(' ')[0]}! üëã</h2>
                            <p style="opacity:0.9; margin-top:5px;">Points: <b>${currentUser.points || 0}</b> | Level: <span style="background:white; color:var(--primary); padding:3px 10px; border-radius:20px; font-size:0.8rem;">${currentUser.level || 1}</span></p>
                            <p style="font-size:0.9rem; opacity:0.8;">${currentUser.education}</p>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:2rem; font-weight:bold; color:white;">${currentUser.level || 1}</div>
                            <div style="font-size:0.8rem;">Level</div>
                        </div>
                    </div>
                </div>
                
                <div class="dash-grid">
                    <div class="dash-btn" onclick="showRoutineView()"><i class="fas fa-calendar-alt" style="color:#FF9F43; font-size:1.5rem; margin-bottom:5px;"></i><br>Routine</div>
                    <div class="dash-btn" onclick="renderStudy()"><i class="fas fa-book-open" style="color:#28C76F; font-size:1.5rem; margin-bottom:5px;"></i><br>Study</div>
                    <div class="dash-btn" onclick="showNotesView()"><i class="fas fa-book-open" style="color:#00CFE8; font-size:1.5rem; margin-bottom:5px;"></i><br>Notes</div>
                </div>

                <h3 style="margin-bottom:15px; color:var(--text);"><i class="fas fa-clock" style="color:var(--primary)"></i> Live Exams</h3>
                
                <div style="margin-bottom:20px;">
                    <select id="category-select" class="category-select" onchange="changeCategory(this.value)" style="width:100%; padding:15px; border:2px solid var(--border); border-radius:15px; background:var(--card-bg); color:var(--text); font-size:1rem;">
                        <option value="">All Categories</option>
                        ${allCategories.map(cat => 
                            `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div id="exam-list">Loading...</div>
            `;
            
            loadExamsByCategory();
        }

        window.changeCategory = (category) => {
            selectedCategory = category;
            localStorage.setItem('selectedCategory', category);
            loadExamsByCategory();
        }

        async function loadExamsByCategory() {
            try {
                let q;
                if(selectedCategory) {
                    q = query(collection(db, "exams"), where("category", "==", selectedCategory));
                } else {
                    q = collection(db, "exams");
                }
                
                const s = await getDocs(q);
                const l = document.getElementById('exam-list');
                
                if(s.empty) {
                    l.innerHTML = '<p style="text-align:center; color:var(--text-sec); padding:20px;">No exams available.</p>';
                    return;
                }
                
                let examHTML = '';
                s.forEach(d => {
                    const data = d.data();
                    const examId = d.id;
                    const isTaken = currentUser.examsTaken && currentUser.examsTaken.includes(examId);
                    
                    examHTML += `
                        <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <div style="flex:1;">
                                <h4 style="font-size:1.1rem; margin-bottom:5px;">${data.title}</h4>
                                <div style="display:flex; gap:8px; align-items:center; margin-bottom:5px;">
                                    <small style="color:var(--text-sec); background:var(--bg); padding:3px 8px; border-radius:5px;">‚è± ${data.time} Min</small>
                                    <small style="color:var(--primary); background:rgba(108, 99, 255, 0.1); padding:3px 8px; border-radius:5px;">${data.category || 'Uncategorized'}</small>
                                </div>
                            </div>
                            <button onclick="${isTaken ? 'showMsg(\'Already taken\')' : `startExam('${examId}', '${data.title}', ${data.time})`}" 
                                    class="btn ${isTaken ? 'btn-sec' : 'btn-primary'}" 
                                    style="width:auto; margin:0; padding:8px 20px; font-size:0.9rem;"
                                    ${isTaken ? 'disabled' : ''}>
                                ${isTaken ? 'Taken' : 'Start'}
                            </button>
                        </div>`;
                });
                
                l.innerHTML = examHTML;
            } catch(error) {
                document.getElementById('exam-list').innerHTML = '<p style="text-align:center; color:var(--danger); padding:20px;">Error loading exams</p>';
            }
        }

        // STUDY PAGE
        window.renderStudy = () => {
            updateNav(1);
            document.getElementById('main-content').innerHTML = `
                <div class="card" style="text-align:center;">
                    <h2><i class="fas fa-book-open"></i> Study Section</h2>
                    <p style="color:var(--text-sec); margin-top:10px;">Coming Soon - Smart Study Plan</p>
                </div>
            `;
        }

        // RANK PAGE
        window.renderRank = () => {
            updateNav(2);
            document.getElementById('main-content').innerHTML = `
                <div class="card" style="text-align:center;">
                    <h2><i class="fas fa-trophy"></i> Rank Section</h2>
                    <p style="color:var(--text-sec); margin-top:10px;">Coming Soon - Leaderboard</p>
                </div>
            `;
        }

        // PROFILE PAGE
        window.renderProfile = () => {
            updateNav(4);
            const avatarUrl = currentUser.avatar || (currentUser.gender === 'Female' ? AVATAR_FEMALE[0] : AVATAR_MALE[0]);
            
            document.getElementById('main-content').innerHTML = `
                <div class="profile-header-card">
                    <div style="width:100px; height:100px; border-radius:50%; margin:0 auto 15px; border:4px solid rgba(255,255,255,0.3); overflow:hidden;">
                        <img src="${avatarUrl}" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <h2 style="text-align:center; margin-bottom:5px;">${currentUser.name}</h2>
                    <p style="text-align:center; opacity:0.9; font-size:0.9rem;">${currentUser.email}</p>
                    
                    <div style="display:flex; justify-content:center; gap:20px; margin-top:15px;">
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:700;">${currentUser.points || 0}</div>
                            <div style="font-size:0.8rem; opacity:0.9;">Points</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:700;">${currentUser.level || 1}</div>
                            <div style="font-size:0.8rem; opacity:0.9;">Level</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:700;">${currentUser.examsTaken ? currentUser.examsTaken.length : 0}</div>
                            <div style="font-size:0.8rem; opacity:0.9;">Exams</div>
                        </div>
                    </div>
                </div>
                
                <button onclick="handleLogout()" class="btn" style="background:var(--bg); color:var(--danger); border:1px solid var(--danger);">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            `;
        }

        // ADMIN PAGE
        window.renderAdmin = () => {
            updateNav(5);
            document.getElementById('main-content').innerHTML = `
                <div class="admin-grid">
                    <div class="admin-item" onclick="admView('exam')"><i class="fas fa-file-alt"></i><h4>Exams</h4></div>
                    <div class="admin-item" onclick="admView('student')"><i class="fas fa-users"></i><h4>Students</h4></div>
                    <div class="admin-item" onclick="admView('routine')"><i class="fas fa-calendar"></i><h4>Routine</h4></div>
                    <div class="admin-item" onclick="admView('notes')"><i class="fas fa-file-pdf"></i><h4>Notes/PDF</h4></div>
                </div>
                <div id="adm-area" style="margin-top:20px;"></div>
            `;
        }

        window.admView = async (m) => {
            const area = document.getElementById('adm-area');
            area.innerHTML = '<div class="card"><div class="spinner" style="margin:0 auto;"></div></div>';

            if(m === 'exam') {
                await loadExamAdminView();
            } else if(m === 'student') {
                await loadStudentAdminView();
            } else if(m === 'routine') {
                await loadRoutineAdminView();
            } else if(m === 'notes') {
                await loadNotesAdminView();
            }
        }

        // ADMIN VIEWS
        async function loadExamAdminView() {
            await loadAllCategories();
            
            const area = document.getElementById('adm-area');
            area.innerHTML = `
                <div class="card">
                    <h3>Create Exam</h3>
                    <input id="nt" placeholder="Title">
                    <input id="nm" type="number" placeholder="Time (Min)">
                    <select id="nc" style="margin-bottom:12px;">
                        <option value="">Select Category</option>
                        ${allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                    <button onclick="addExam()" class="btn btn-primary">Create</button>
                </div>
                
                <div class="card">
                    <h3>Manage Exams</h3>
                    <div id="el" class="grid-container"></div>
                </div>
            `;
            
            await loadAdminExams();
        }

        async function loadAdminExams() {
            try {
                const s = await getDocs(collection(db, "exams")); 
                let h=''; 
                s.forEach(d=>{ 
                    const data = d.data();
                    h+=`<div class="mini-card" onclick="delDoc('exams','${d.id}')">
                        <i class="fas fa-file-contract" style="color:var(--primary)"></i>
                        <h4>${data.title}</h4>
                        <small>${data.time} Min</small>
                    </div>`; 
                });
                document.getElementById('el').innerHTML = h || "<p>No exams.</p>"; 
            } catch(error) {
                document.getElementById('el').innerHTML = '<p style="color:var(--danger);">Error loading exams</p>';
            }
        }

        window.addExam = async () => { 
            const title = document.getElementById('nt').value;
            const time = parseInt(document.getElementById('nm').value);
            const category = document.getElementById('nc').value;
            
            if(!title || !time || !category) {
                return showMsg("Please fill all fields");
            }
            
            await addDoc(collection(db, "exams"), {
                title: title, 
                time: time,
                category: category,
                createdAt: Date.now()
            }); 
            
            showMsg("Created"); 
            admView('exam'); 
        }

        async function loadStudentAdminView() {
            const area = document.getElementById('adm-area');
            area.innerHTML = `
                <div class="card">
                    <h3>Registered Students</h3>
                    <div id="sl" class="grid-container">Loading...</div>
                </div>`;
            
            try {
                const s = await getDocs(collection(db, "users"));
                let h = '';
                s.forEach(d => { 
                    const data = d.data();
                    if(data.role !== 'admin') {
                        const av = data.avatar || (data.gender === 'Female' ? AVATAR_FEMALE[0] : AVATAR_MALE[0]);
                        
                        h += `<div class="mini-card" onclick="viewUser('${d.id}')">
                            <img src="${av}" style="width:50px; height:50px; border-radius:50%; margin-bottom:10px; object-fit:cover;">
                            <h4>${data.name}</h4>
                            <small>${data.education}</small>
                        </div>`;
                    }
                });
                document.getElementById('sl').innerHTML = h || '<p>No students found.</p>';
            } catch(error) {
                document.getElementById('sl').innerHTML = '<p style="color:var(--danger);">Error loading students</p>';
            }
        }

        window.viewUser = async (uid) => {
            const uSnap = await getDoc(doc(db, "users", uid));
            const u = uSnap.data();
            
            openModal("Student Details", `
                <div style="text-align:center;">
                    <h3 style="color:var(--primary)">${u.name}</h3>
                    <p>${u.email}</p>
                    <p style="font-size:0.8rem; color:var(--text-sec)">Joined: ${u.joined}</p>
                    <div style="display:flex; justify-content:center; gap:10px; margin:10px 0;">
                        <div style="background:var(--bg); padding:10px; border-radius:10px;">
                            <div style="font-size:1.5rem; color:var(--primary);">${u.points || 0}</div>
                            <div style="font-size:0.8rem;">Points</div>
                        </div>
                        <div style="background:var(--bg); padding:10px; border-radius:10px;">
                            <div style="font-size:1.5rem; color:var(--warning);">${u.level || 1}</div>
                            <div style="font-size:0.8rem;">Level</div>
                        </div>
                    </div>
                    <button onclick="toggleBan('${uid}', ${u.isBanned})" class="btn" style="background:${u.isBanned ? 'var(--success)' : 'var(--danger)'}; color:white; margin:15px 0;">
                        ${u.isBanned ? "Unban Student" : "Ban Student"}
                    </button>
                </div>
            `);
        }
        
        window.toggleBan = async (uid, currentStatus) => {
            await updateDoc(doc(db, "users", uid), { isBanned: !currentStatus });
            showMsg(currentStatus ? "User Unbanned" : "User Banned");
            closeModal();
            admView('student'); 
        }

        async function loadRoutineAdminView() {
            const area = document.getElementById('adm-area');
            area.innerHTML = `<div class="card"><h3>Add Routine</h3><input id="rt" placeholder="Title"><input id="rm" placeholder="Time"><button onclick="addRT()" class="btn btn-primary">Add</button></div><div class="card"><h3>Manage</h3><div id="rl"></div></div>`;
            
            try {
                const s = await getDocs(collection(db, "routines")); 
                let h=''; 
                s.forEach(d=>{ 
                    h+=`<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border);"><span>${d.data().title}</span><button class="btn btn-danger" style="width:auto; padding:5px 10px;" onclick="delDoc('routines','${d.id}')">Del</button></div>`; 
                });
                document.getElementById('rl').innerHTML = h;
            } catch(error) {
                document.getElementById('rl').innerHTML = '<p style="color:var(--danger);">Error loading routines</p>';
            }
        }
        
        window.addRT = async () => { 
            await addDoc(collection(db, "routines"), {
                title:document.getElementById('rt').value, 
                time:document.getElementById('rm').value, 
                createdAt: Date.now()
            }); 
            showMsg("Added"); 
            admView('routine'); 
        }

        async function loadNotesAdminView() {
            const area = document.getElementById('adm-area');
            area.innerHTML = `<div class="card"><h3>Add PDF</h3><input id="pt" placeholder="Title"><input id="pl" placeholder="Link"><button onclick="addNT()" class="btn btn-primary">Add</button></div><div class="card"><h3>Manage</h3><div id="nl"></div></div>`;
            
            try {
                const s = await getDocs(collection(db, "notes")); 
                let h=''; 
                s.forEach(d=>{ 
                    h+=`<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border);"><span>${d.data().title}</span><button class="btn btn-danger" style="width:auto; padding:5px 10px;" onclick="delDoc('notes','${d.id}')">Del</button></div>`; 
                });
                document.getElementById('nl').innerHTML = h;
            } catch(error) {
                document.getElementById('nl').innerHTML = '<p style="color:var(--danger);">Error loading notes</p>';
            }
        }
        
        window.addNT = async () => { 
            await addDoc(collection(db, "notes"), {
                title:document.getElementById('pt').value, 
                link:document.getElementById('pl').value, 
                createdAt: Date.now()
            }); 
            showMsg("Added"); 
            admView('notes'); 
        }
        
        window.delDoc = async (c, id) => { 
            if(await customConfirm("Are you sure you want to delete?")) { 
                await deleteDoc(doc(db, c, id)); 
                showMsg("Deleted"); 
                if(c==='exams') admView('exam');
                else if(c==='routines') admView('routine');
                else if(c==='notes') admView('notes');
            } 
        }

        // FEATURES
        window.showRoutineView = async () => {
            openModal("Class Routine", "Loading...");
            try {
                const snap = await getDocs(collection(db, "routines"));
                let h = snap.empty ? "<p>No routine added.</p>" : "";
                snap.forEach(d => h += `<div style="padding:15px; background:var(--bg); border-radius:10px; margin-bottom:10px;"><b>${d.data().title}</b><br><span style="color:var(--primary)">${d.data().time}</span></div>`);
                document.getElementById('modal-body').innerHTML = h;
            } catch(error) {
                document.getElementById('modal-body').innerHTML = '<p style="color:var(--danger);">Error loading routine</p>';
            }
        }
        
        window.showNotesView = async () => {
            openModal("Notes & PDF", "Loading...");
            try {
                const snap = await getDocs(collection(db, "notes"));
                let h = snap.empty ? "<p>No notes found.</p>" : "";
                snap.forEach(d => h += `<div style="padding:15px; background:var(--bg); border-radius:10px; margin-bottom:10px;"><span>üìÑ ${d.data().title}</span><br><a href="${d.data().link}" target="_blank" style="color:var(--primary);">Download PDF</a></div>`);
                document.getElementById('modal-body').innerHTML = h;
            } catch(error) {
                document.getElementById('modal-body').innerHTML = '<p style="color:var(--danger);">Error loading notes</p>';
            }
        }

        // MCQ ENGINE
        window.startExam = async (id, title, time) => {
            if(currentUser.examsTaken && currentUser.examsTaken.includes(id)) {
                showMsg("You have already taken this exam!");
                return;
            }
            
            const div = document.getElementById('main-content');
            div.innerHTML = `<div id="q-area" style="padding-bottom:50px;">Loading questions...</div>`;
            
            try {
                const q = query(collection(db, "questions"), where("examId", "==", id));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    div.innerHTML = "<div class='card'>No questions found for this exam.</div>";
                    return;
                }

                let qs = []; 
                snap.forEach(d => qs.push({id: d.id, ...d.data()}));
                window.currentQ = qs; 
                window.userAns = {};
                window.currentExamId = id;

                let html = `
                    <div style="position:sticky; top:75px; background:var(--card-bg); padding:15px; border-radius:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:var(--primary); font-size:1.1rem;">${title}</b>
                        <span id="timer" style="background:var(--gradient-primary); color:white; padding:5px 12px; border-radius:20px; font-weight:bold;">${time}:00</span>
                    </div>`;

                qs.forEach((d, i) => {
                    html += `
                    <div class="card" style="animation:fadeIn 0.5s; animation-delay: ${i*0.05}s">
                        <p style="font-weight:600; margin-bottom:15px;">
                            <span style="color:var(--primary)">Q${i+1}.</span> ${d.question || d.q}
                        </p>
                        <div id="opts-${d.id}">
                            ${d.options.map((o, idx) => `
                                <div class="mcq-option" onclick="selectOpt('${d.id}', ${idx+1}, this)">
                                    <div style="height:20px; width:20px; border:2px solid var(--text-sec); border-radius:50%; margin-right:15px; display:flex; align-items:center; justify-content:center;"></div>
                                    <span>${o}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });

                html += `<button onclick="submitExam('${title}')" class="btn btn-primary" style="margin-top:20px;">Submit Exam</button>`;
                document.getElementById('q-area').innerHTML = html;

                let left = time * 60;
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    let m = Math.floor(left/60), s = left % 60; 
                    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' + s : s}`;
                    
                    if(left <= 60) document.getElementById('timer').style.background = "linear-gradient(135deg, #ff4757 0%, #ff3838 100%)";
                    
                    left--; 
                    if(left < 0) {
                        clearInterval(timerInterval);
                        submitExam(title);
                    }
                }, 1000);
            } catch(error) {
                div.innerHTML = "<div class='card'>Error loading exam questions.</div>";
            }
        }

        window.selectOpt = (qid, idx, el) => {
            window.userAns[qid] = idx;
            const p = document.getElementById(`opts-${qid}`);
            Array.from(p.children).forEach(c => {
                c.classList.remove('selected');
                c.querySelector('div').style.background = '';
                c.querySelector('div').style.borderColor = 'var(--text-sec)';
            });
            el.classList.add('selected');
            el.querySelector('div').style.background = 'var(--primary)';
            el.querySelector('div').style.borderColor = 'var(--primary)';
            el.querySelector('div').innerHTML = '<div style="width:8px; height:8px; background:white; border-radius:50%;"></div>';
        }

        window.submitExam = async (title) => {
            clearInterval(timerInterval); 
            toggleLoader(true);
            
            let score = 0, totalQuestions = window.currentQ.length;
            let pointsChange = 0;
            
            window.currentQ.forEach((q, i) => {
                const ans = window.userAns[q.id];
                const correct = ans === parseInt(q.correct);

                if(ans) {
                    if(correct) {
                        score += 1;
                        pointsChange += 1;
                    } else {
                        score -= 0.5;
                        pointsChange -= 0.5;
                    }
                }
            });

            if (score < 0) score = 0;
            
            const newPoints = Math.max(0, (currentUser.points || 0) + pointsChange);
            const newLevel = Math.floor(newPoints / 100) + 1;
            
            const examsTaken = currentUser.examsTaken || [];
            if(!examsTaken.includes(window.currentExamId)) {
                examsTaken.push(window.currentExamId);
            }
            
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { 
                    points: newPoints, 
                    level: newLevel,
                    examsTaken: examsTaken
                });
                
                currentUser.points = newPoints;
                currentUser.level = newLevel;
                currentUser.examsTaken = examsTaken;
                
                renderHome();
                
                openModal(`Result: ${score.toFixed(1)}/${totalQuestions}`, `
                    <div style="text-align:center; padding:20px 0;">
                        <h1 style="font-size:4rem; color:var(--primary); line-height:1;">${score.toFixed(1)}</h1>
                        <p style="color:var(--text-sec)">Out of ${totalQuestions}</p>
                        <p style="color:var(--text-sec); margin-bottom:15px;">(${((score/totalQuestions)*100).toFixed(1)}%)</p>
                        <div style="margin:15px 0; padding:15px; background:var(--bg); border-radius:12px;">
                            <div style="display:flex; justify-content:space-around;">
                                <div>
                                    <div style="font-size:1.5rem; color:var(--primary);">${newPoints}</div>
                                    <div style="font-size:0.8rem;">Total Points</div>
                                </div>
                                <div>
                                    <div style="font-size:1.5rem; color:${pointsChange >= 0 ? 'var(--success)' : 'var(--danger)'};">${pointsChange > 0 ? '+' : ''}${pointsChange}</div>
                                    <div style="font-size:0.8rem;">Points Change</div>
                                </div>
                                <div>
                                    <div style="font-size:1.5rem; color:var(--warning);">${newLevel}</div>
                                    <div style="font-size:0.8rem;">Level</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="renderHome()" class="btn btn-primary" style="width:100%;">Back to Home</button>`);
            } catch(error) {
                showMsg("Error submitting exam.");
            } finally {
                toggleLoader(false);
            }
        }

        // HELPER FUNCTIONS
        function updateNav(i) { 
            document.querySelectorAll('.nav-item').forEach((n,x)=> n.classList.toggle('active', i===x)); 
        }
        
        function openModal(t, b) { 
            document.getElementById('modal-title').innerText = t; 
            document.getElementById('modal-body').innerHTML = b; 
            document.getElementById('generic-modal').style.display = 'flex'; 
        }
        
        window.closeModal = () => document.getElementById('generic-modal').style.display = 'none';
        
        function toggleLoader(s) { 
            document.getElementById('loader').style.display = s?'flex':'none'; 
        }

        // INITIALIZE
        document.addEventListener('DOMContentLoaded', function() {
            updateNetworkStatus();
            setTimeout(hideSplash, 2000);
        });

    </script>
</body>
</html>
